### 修正指示メモ

いい感じに出来てるじゃん！！！

1. 修正してほしいところ

   1. トップページ
      1. スマホ表示にしたときに、ヘッダーのメニュー名が見切れている。翌日営業準...みたいになってる。このアプリは基本スマホでしか使わないので、スマホでのUIをまずは最適化したい
      2. 業務日付の選択は、基本常にその日が初期値で入っていればよくてそんなに触ることはない。一応入力できる状態であればいいみたいな感じだから、UIとしてはカレンダーじゃなくていい。もっと場所を取らない感じにしてほしい。
      3. 業務メニューを業務日付の次に表示してほしい。
         1. ページとしては上から順に、以下の要素が並ぶイメージ。
            1. ヘッダー
            2. 業務日付
            3. 業務メニュー
            4. 予約状況
      4. 予約欄のUI
         1. 翌営業日の予約管理の紙を見て、翌営業日に予約されている商品名とその予約数、予約状況などのメモ（例えば、いつもと違って〇〇時にクローズとか、予約の〇〇さんはアレルギーありとか。）を記入できるだけでいいんだ。
         2. だから、下記のような入力欄を想定していた。UIのイメージが
            1. 大きめのメモ入力欄
            2. 商品名と予約数を追加していけるリスト
               1. 商品の名前、予約数を記入して、プラスボタン押したらもう一件入力できるようになる、みたいなもの
      5. 再掲：トップページの要件
         - 業務日付の入力欄、各ページを開くためのボタンと、紙で管理している翌日の営業に関する予約数や予約状況などをメモできる入力欄を設ける。
         - 紙で管理している翌日の営業に関する予約数や予約状況などをメモできるように入力欄を設けるだけで、予約状況トランと商品予約トランに書き込めればそれで十分。予約管理機能は今回は作らず、紙での運用のままにする。
         - シンプルで迷わない、なるべく縦幅が画面の高さに収まってスクロールが最小限になるようなUIとする。

   - メニュー名は補充（作成）と補充（移動）にしてほしい。
     - あとこのくらいは自分で直そうと思ってソース見たけど、複数箇所で使い回す可能性のある文言は、labels.ymlみたいなものを作って一元管理できるようにしてくれると嬉しい。管理方法は定数クラス作るとか、何でもいいけど、複数箇所を毎回治すのは避けたい。
   - ヘッダーと業務日付の間は開けなくていい、上揃えでいい。
   - 商品名と予約数については、数量→予約数にラベル名を変えてほしい
   - 予約を追加じゃなくて、ただのプラスアイコンをリストの右下に出すみたいなUIにしたい。
   - あと、商品名と予約数は最初から1件は表示しておいてほしい。初期値のままで商品名が空、予約数が0だったらDBに登録しないみたいな挙動にすればいいので。
   - 予約状況のメモ欄は、商品名と予約数の下でいい。
   - 予約状況のメモ欄は高さがあと1.5倍くらいあってもいいかも
   -
   - スマホサイズでの表示にしたときに、ヘッダーのメニュー名が見切れている。翌日営業準...みたいになってる。見切れないように表示してほしい。
   -
   - ヘッダーの下の青いバーの翌日営業準備はいらない。
   - 予約状況欄の背景色がダークモードにしたときに真っ白だ
   - プラスアイコンが商品名と予約数のリストの右下じゃなくて、メモ欄の上にかぶる形で表示されちゃっている。多分外側の、予約状況の枠の右下に出ちゃってるんだと思う。
   - 目立つボタンなどの特徴的な部分にはライトモードのときのプライマリカラーとして#e07833を使ってほしい
   - 予約状況の背景青くなくていい
   - 業務日付って文言は出さなくていい
   -

   - [x] 各ページへ飛ぶためのリンクリストが業務日付と予約入力欄の間にあったはずなのに消えちゃってるじゃん。押しても今は飛べなくていいから、見た目だけでも残しておいて欲しい。
   - [x] 予約入力欄には、明日の予約みたいな文言を表示してほしい。何を書く欄なのかわからない。
   - [x] 予約数が見切れて予..ってなっちゃってる。

- [x] 業務日付と予約入力欄の間にあった各ページへ飛ぶためのリンクリストを復活させてほしい。
-
- いまはトップページとサイドパネルだけは完成した。
- 他のページはまだできていない。各ページへのリンクも切れている。
- これから在庫確認業務画面をつくっていこう。
- ここで、改めてこのアプリの要件のドキュメントも再掲する。
- [x] プラスボタンはあくまで、商品名と予約数の組のリスト、というか表？に対しての追加する操作だってのがわかる位置に表示してほしい。いまだとなぜか予約入力欄の一番下にあって分かりづらい。
  - [x] プラスボタンは今の位置から右揃えにしておいてほしい。
  - [x] 予約を追加の文言はいらない。
  - [ ] プラスボタンが相変わらず背景色と被って見えない。プライマリカラーの#e07833つかって欲しい。
- [x] ダークモードとライトモードの切り替えの導線は、ヘッダーのハンバーガーメニューから開けるサイドメニューの、一番下の方に、各ページへのリンクリストとは別だと分かる形で追加してほしい。
- [x] 商品名と予約数の組を削除するゴミ箱アイコンを復活させてほしい。
- [x] スマホサイズでの表示にしたときに、ヘッダーのメニュー名が見切れている。翌日営業準...みたいになってる。見切れないように表示してほしい。
- [x] ダークモードとライトモードの切り替えボタンは、ヘッダーの右上にはいらないから消してくれ。
- [x] 明日の予約の欄の外側の枠線が業務日付とか他の欄と違うので揃えてほしい。
- [x] ダークモードとライトモードの切り替えの導線は、トップページの各ページへ飛ぶためのリンクリストの最後には必要ないので消してほしい。
- [x] 初期描画時点で、商品名と予約数は必ず1件表示しておいてほしい。初期描画したときは予約数0、プラスボタンから追加したときは予約数1で追加する
- [x] 初期値（商品名が空、予約数が0）のときは保存しないようにすればいいと思うので。
- [x] プラスボタン押したときに商品名と予約数が追加されなくてそもそも動作確認ができない

### 現在の進捗状況（2024/04/29更新）

#### 完了したタスク

- [x] トップページの基本レイアウト実装
- [x] サイドパネルの実装
- [x] ダークモード/ライトモードの切り替え機能
- [x] ヘッダーのメニュー名表示の修正
- [x] 業務日付のUI改善
- [x] 予約入力欄のUI改善
- [x] プラスボタンの位置調整
- [x] ゴミ箱アイコンの実装
- [x] 各ページへのリンクリストの復活
- [x] プラスボタンの色をプライマリカラー（#e07833）に変更
- [x] 初期描画時の商品名と予約数の1件表示
- [x] プラスボタンの動作確認と修正
- [x] 予約入力欄の背景色のダークモード対応
- [x] MyBatisからJPAへの移行
- [x] UUIDの統一（v7の採用）
- [x] トップページの自動保存機能の実装
  - [x] LocalStorageへの保存機能
  - [x] DBへの保存機能
  - [x] 入力欄からカーソルが外れたタイミングでの保存
- [x] Google認証（Googleログイン）機能の実装

#### 進行中のタスク

- [ ] テスト基盤整備

  - [ ] Vitestの導入
  - [ ] テスト環境の構築
  - [ ] 既存コンポーネントのテスト実装

- [ ] 在庫確認業務画面の実装
  - [x] 基本レイアウトの実装
  - [x] 補充先ごとの画面切り替え機能
  - [x] 在庫確認ステータスの管理機能
  - [x] 補充ステータスの管理機能
  - [ ] 品物ごとのメモ機能の実装
  - [ ] 自動保存機能の実装
    - [ ] バックエンドとの通信の疎通確認（CRUDすべて）

#### 残タスク

1. 補充（移動）業務画面

   - [x] 基本レイアウトの実装
   - [ ] 補充元ごとの画面切り替え機能
   - [ ] 補充ステータスの管理機能
   - [ ] 自動保存機能の実装

2. 補充（作成）業務画面

   - [x] 基本レイアウトの実装
   - [ ] 作成ステータスの管理機能
   - [ ] 自動保存機能の実装

3. 発注依頼業務画面

   - [x] 基本レイアウトの実装
   - [ ] 発注依頼ステータスの管理機能
   - [ ] 自動保存機能の実装

4. 営業準備状況一覧画面

   - [x] 基本レイアウトの実装
   - [ ] 要対応品目の絞り込み機能
   - [ ] 各種ステータスの表示機能

5. 共通機能
   - [x] ラベル管理の一元化（labels.yml等の実装）
   - [x] エラーハンドリングの実装
   - [ ] パフォーマンス最適化
   - [ ] 区分値の一元管理
     - [ ] 場所タイプ（'01': 補充先, '02': 補充元）
     - [ ] ステータス値（'01': 未確認, '02': 確認済み など）
     - [ ] その他の区分値
   - [ ] 自動保存機能の共通化・リファクタリング
     - [ ] 詳細は[自動保存設計方針](./自動保存設計方針.md)を参照
     - [ ] 基本設定の一元管理
     - [ ] カスタムフックの実装
     - [ ] 状態表示用コンポーネントの実装
     - [ ] 既存画面への適用
     - [ ] テストの実装

### 優先度の高いタスク

1. テスト基盤整備
2. 在庫確認業務画面のAPI連携完了
3. 補充（移動）業務画面のAPI連携開始

### 移行計画（2025/05/17更新）

#### フロントエンド（Vue.js → Next.js）

- [x] 流用可能な部分の特定
  - [x] UIコンポーネントの設計思想
  - [x] 画面遷移のロジック
  - [x] 状態管理の概念
  - [x] 自動保存のロジック
- [ ] 新規実装が必要な部分
  - [ ] Next.jsのプロジェクト構造への移行
  - [ ] コンポーネントの書き換え
  - [ ] APIクライアントの実装
  - [ ] ルーティングの実装

#### バックエンド（Java → Supabase）

- [x] 流用可能な部分の特定
  - [x] データモデルの設計
  - [x] ビジネスロジックの概念
  - [x] エラーハンドリングの考え方
- [ ] 新規実装が必要な部分
  - [x] Supabaseのプロジェクト設定
  - [ ] データベースの移行
  - [ ] APIエンドポイントの実装
  - [ ] 認証・認可の実装

#### データベース（PostgreSQL → Supabase）

- [x] 流用可能な部分の特定
  - [x] テーブル設計
  - [x] リレーションシップ
  - [x] インデックス設計
- [x] 新規実装が必要な部分
  - [x] Supabaseへのスキーマ移行
  - [x] マイグレーションスクリプト
  - [x] データの移行

#### 移行手順

1. データベース移行

   - [x] Supabaseプロジェクトの作成
   - [x] スキーマの移行
   - [x] 既存データの移行

2. バックエンド移行

   - [x] Supabaseの設定
   - [ ] APIエンドポイントの実装
   - [x] 認証・認可の実装

3. フロントエンド移行
   - [x] Next.jsプロジェクトの作成
   - [ ] 共通コンポーネントの実装
   - [ ] 画面コンポーネントの実装
   - [ ] APIクライアントの実装

次回のタスク
使い方を設計ドキュメントにまとめる
区分値のUtilsと同じような感じで、共通機能の使い方をまとめる
在庫確認画面で自動保存する実装を進めて

- [ ] placeの補充元先の区分は無くす
- [ ] item_inventoryだっけ？を、fromのplace_idでgroup by したときのdistinctなリストをビューテーブルとして保持するか、Select文を工夫する
- [ ] 自動保存のローカルストレージへの保存キーの命名規則の設計
- [ ] 在庫確認画面のテスト作成とドキュメントに修正反映
      要補充の品物だけをリスト表示

品物名　　　　　　✓　▽
品物名　　　　　　✓　▽
品物名　　　　　　✓　△
「発注不要/要発注依頼/発注依頼済」　「作成不要/要作成/作成済」
「　メモ欄　　　　　　」

プロンプト
あなたが超凄腕のプログラマーだとして、この辺のコードをレビューしてくれと言われたら、どんな点を改善点として指摘する？
マークダウン形式でファイルごとにTODOとしてまとめて

### TODO: コード改善検討リスト

1. app/inventory/page.tsx

- [x] createInventoryStatusFromViewModelの多重呼び出しを1回にまとめ、変数で使い回す（パフォーマンス最適化）
  - items.map内でconst status = createInventoryStatusFromViewModel(viewModel, selectedDate)とし、以降のpropsはstatus.xxxで参照する
  - ループ内で同じviewModel/selectedDateの組み合わせで複数回呼ばれている箇所を全て1回の呼び出しに集約する
  - 他のitemには干渉せず、itemごとに独立して処理する
- [x] handleItemStatusChangeのvalue: anyを型安全に（InventoryStatus[keyof InventoryStatus]等で厳密化）
- [x] checkedItemsの管理方法を見直し、業務データ（check_status）から導出する形も検討
  - checkedItemsのuseStateやsetCheckedItemsを廃止し、isCheckedはisEnumCode(INVENTORY_STATUS, viewModel.status?.check_status ?? getCode(INVENTORY_STATUS, 'UNCONFIRMED'), 'CONFIRMED')のように業務データから直接判定する
  - チェックボックスの一括操作もitemsのcheck_statusのみを更新する形に統一
  - 状態の二重管理を排除し、バグ防止・保守性向上を図る
- [x] エラー・ローディング表示のカスタマイズ性・再利用性を高める（共通UIコンポーネント化・アクセシビリティ対応・labels/messages一元管理）
- [x] バッジ集計やチェック状態更新などの業務ロジックを関数として切り出し、ユニットテストしやすくする

2. components/inventory/inventory-item-card.tsx

- [ ] isMemoOpenの初期値判定をprops依存からuseEffectで同期する形に修正
- [ ] onCheckedChange等のコールバックをuseCallbackでラップし、不要な再レンダリングを防ぐ
- [ ] メモ欄のplaceholderに説明文や例を追加し、UX向上
- [ ] チェックボックスやスイッチのaria-labelをより明示的に
- [ ] コールバック型（onCheckChange等）を(checked: boolean) => voidで統一し、呼び出し側と型を揃える
- [ ] 入力欄にinputmodeやpatternを追加し、スマホ対応を強化
- [ ] メモ欄の高さや改行挙動をUX観点で調整

3. components/inventory/place-selector.tsx

- [ ] filteredPlacesやplaceholderをuseMemoでメモ化し、パフォーマンス最適化
- [ ] セレクトのラベルや説明文を追加し、アクセシビリティ向上（aria-labelやaria-describedbyの追加）
- [ ] onPlaceChangeの引数型（string）とPlace型の整合性を明示

4. app/inventory/AutoSaveWrapper.tsx

- [ ] handleBeforeUnloadでawaitしているが、beforeunloadイベントの仕様上、重要な保存処理は他のタイミング（フォーカスアウト等）でも冗長化する
- [ ] AutoSaveWrapperの責務が「ラップ＋イベント管理」だけであれば、より汎用的な名前や設計も検討

総合

- [ ] useMemo, useCallback, 差分検知の効率化などパフォーマンス最適化
- [ ] anyの排除、props/callbackの型厳密化など型安全性の強化
- [ ] aria属性、ラベル、説明文の充実などアクセシビリティ向上
- [ ] UI/業務ロジック/状態管理の責務分離
- [ ] ロジックの関数化・テストコードの充実などテスト容易性の向上
- [ ] エラー・ローディング・入力補助のUX強化

4. テスト基盤の整備
   - [ ] テスト環境の構築
   - [ ] テストケースの作成
   - [ ] CI/CDの設定

#### 優先度の高いタスク

1. [x] Supabaseプロジェクトの作成と設定
2. [ ] データベーススキーマの移行
3. [ ] 基本的なAPIエンドポイントの実装
4. [x] Next.jsプロジェクトの初期設定
5. [ ] 共通コンポーネントの実装
