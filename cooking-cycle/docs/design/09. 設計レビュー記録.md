# 設計レビュー記録

## レビュー日
2025-01-XX（外部レビュー）

## レビュー概要

設計ドキュメント（9ファイル）に対する詳細レビューを実施。コンセプトの具現化と設計の整合性について高く評価された。同時に、3つの改善提案が提示された。

## 評価された点

### 1. コンセプトの具現化：設計の整合性

**評価内容：**
- 「レシピ＝複数の戻り値（主産物と副産物）を持つ関数」という概念が、`RECIPE_OUTPUTS`テーブルに見事に反映されている
- Phase 1で`state_memo`（自由記述）で妥協しつつ、Phase 2で`ingredient_id`と`state_transition_id`による正規化を行う「段階的移行」の設計は、開発の現実味と理想を両立させている

### 2. プログラマブルな「呼び出しチェーン」

**評価内容：**
- 「カレー = ポトフ（レシピA） + カレー粉」のような、レシピのアウトプットを別のレシピのインプットにする連鎖が、`RECIPE_COMPONENTS`と`RECIPE_OUTPUTS`のリレーションによってデータ構造上、実現可能になっている

### 3. 状態遷移の正規化

**評価内容：**
- 処理（PROCESSES）の抽象化：処理マスタに`parameters` (JSONB)を持たせることで、温度や時間といった変数をプログラマブルに扱えるよう設計されている
- 状態の正規化：`INGREDIENT_STATE_TRANSITIONS`テーブルが、「どの食材に」「どの処理をしたら」「どの状態（プロダクト）になるか」というステートマシンの役割を担っている
- 「洗った葉野菜」や「焼いたひき肉」を、単なる名前ではなく**「元食材ID + 処理ID」の組み合わせ**として厳密に管理できる土台が整っている

## 改善提案

### ① コンテキストによるパラメータ調整の実装ロジック

**提案内容：**
`01. 機能要件定義書.md`で言及されている「しらすを入れるから茹で汁の塩分を引く」といったトータルコーディネートのロジックは、現在の`PROCESSES`テーブルの定義だけでは不十分かもしれない。

**具体的な提案：**
- レシピ実行時に、各材料が持つ属性（例：`salt_content`）を動的に集計し、処理（`boil`）のパラメータを上書きする「ミドルウェア」的な処理ロジックの定義をPhase 2で検討

**対応方針：**
- Phase 2の設計時に、レシピ実行エンジンの設計として検討項目に追加
- 材料の属性管理方法（PRODUCTSテーブルに属性カラムを追加するか、別テーブルで管理するか）を検討

### ② テスト仕様の高度化

**提案内容：**
現在の`07. 単体テスト仕様書.md`はPhase 1の基本的なCRUD操作が中心。状態遷移ロジックそのものを検証するテストケースを追加することで、よりプログラマブルな信頼性が担保される。

**具体的な提案：**
- 「生の状態の食材に『焼く』処理を適用したら、期待通りの状態IDを持つストックが生成されるか」といった、**状態遷移ロジックそのものを検証するテストケース**を追加

**対応方針：**
- `07. 単体テスト仕様書.md`に、Phase 2以降の状態遷移ロジックのテストケースを追加
- テスト対象機能として「状態遷移管理機能」のセクションを追加

### ③ 画面設計への「遷移」の統合

**提案内容：**
`02. 画面設計書.md`に「状態遷移管理画面」がPhase 2以降として定義されているが、これは非常に重要。

**具体的な提案：**
- ユーザーが「ひき肉を炒めた」というアクションを記録する際、システムが自動的に「ひき肉（生）」を消費し、「ひき肉（炒め）」のストックを生成するUI/UXのフローを詳細化すると、実用性が飛躍的に高まる

**対応方針：**
- `02. 画面設計書.md`に、状態遷移実行時のUI/UXフローを追加
- ストック登録画面に「状態遷移を適用する」機能の詳細設計を追加

## 参考情報

### コマンド形式での操作例（設計の反映）

今回の設計に基づき、システムが裏側で実行するであろう論理的な操作をCLI風に説明：

**状態遷移の定義：**
```
create-transition --input raw_meat --process frying --output fried_soboro
```
- 操作説明：食材マスタの「生肉」に「炒める」という処理を適用し、出力結果を「そぼろ」として定義する状態遷移ルールをデータベースに登録

**レシピの実行：**
```
execute-recipe --recipe_id curry_from_potaufeu --inputs [potaufeu_stock_id, curry_powder_id]
```
- 操作説明：既存のストック（ポトフ）をインプットとして、カレーレシピ（メソッド）を実行し、新しいアウトプット（カレー）を生成してストックを更新

### 参考リンク

- **状態パターン (State Pattern):** オブジェクトの状態をクラスとしてカプセル化する設計手法は、今回の`INGREDIENT_STATE_TRANSITIONS`の実装に非常に近い
  - [Refactoring.Guru - State](https://refactoring.guru/design-patterns/state)
- **データ正規化 (Normalization):** 食材と状態を分離する考え方は、データベース設計の基本原則に基づいている
  - [Wikipedia - Database Normalization](https://en.wikipedia.org/wiki/Database_normalization)

## 今後の対応

### 即座に対応すべき項目

1. **テスト仕様の追加**（`07. 単体テスト仕様書.md`）
   - 状態遷移ロジックのテストケースを追加

2. **画面設計の詳細化**（`02. 画面設計書.md`）
   - 状態遷移実行時のUI/UXフローを追加

### Phase 2設計時に検討すべき項目

1. **パラメータ調整ロジックの設計**
   - レシピ実行エンジンの設計
   - 材料の属性管理方法

2. **状態遷移の実装詳細**
   - 処理の抽象化・共通化の難しさを考慮した実装方針の明確化

## レビューの総評

非常に理にかなった素晴らしい設計書。このままPhase 1の実装に進み、実際に使いながら「処理の抽象化」の粒度を調整していくのが最善の道。
