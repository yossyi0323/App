# 統合テスト仕様書（E2Eテスト）

## 概要

E2Eテストのシナリオ、テストフロー、テスト環境構成を定義します。

## テスト環境

- **テストフレームワーク:** Playwright
- **ブラウザ:** Chromium, Firefox, WebKit
- **テスト環境:** Docker Compose（開発環境と同じ構成）

## E2Eテストシナリオ一覧

### 1. 認証フロー

#### 1.1 Google認証
**シナリオ:** ユーザーがGoogle認証でログインする

**テストフロー:**
1. ホーム画面にアクセス
2. 「ログイン」ボタンをクリック
3. Google認証ページにリダイレクト
4. Googleアカウントでログイン
5. ホーム画面にリダイレクト
6. ユーザー名が表示されることを確認

**期待結果:**
- 認証が成功する
- セッションが保持される
- ホーム画面が表示される

### 2. レシピ管理フロー

#### 2.1 レシピ登録
**シナリオ:** ユーザーがレシピを登録する

**テストフロー:**
1. ログイン
2. 「レシピ登録」ボタンをクリック
3. レシピ登録画面で以下を入力:
   - レシピ名: 「ペペロンチーノ」
   - 材料: 「にんにく」「オリーブオイル」「パスタ」
   - 手順: 「1. にんにくをみじん切り\n2. オリーブオイルで炒める」
   - YouTube URL: 「https://youtube.com/watch?v=test」
4. 「登録」ボタンをクリック
5. レシピ一覧画面に遷移
6. 登録したレシピが表示されることを確認

**期待結果:**
- レシピが正常に登録される
- レシピ一覧に表示される
- レシピ詳細画面で内容が確認できる

#### 2.2 レシピ編集
**シナリオ:** ユーザーがレシピを編集する

**テストフロー:**
1. ログイン
2. レシピ一覧からレシピを選択
3. レシピ詳細画面で「編集」ボタンをクリック
4. レシピ編集画面でレシピ名を変更
5. 「更新」ボタンをクリック
6. レシピ詳細画面に遷移
7. 変更が反映されていることを確認

**期待結果:**
- レシピが正常に更新される
- 変更内容が反映される

#### 2.3 レシピ削除
**シナリオ:** ユーザーがレシピを削除する

**テストフロー:**
1. ログイン
2. レシピ一覧からレシピを選択
3. レシピ詳細画面で「削除」ボタンをクリック
4. 削除確認ダイアログで「削除」をクリック
5. レシピ一覧画面に遷移
6. 削除したレシピが表示されないことを確認

**期待結果:**
- レシピが正常に削除される
- レシピ一覧から削除される

#### 2.4 レシピ詳細表示
**シナリオ:** ユーザーがレシピ詳細を確認する

**テストフロー:**
1. ログイン
2. レシピ一覧からレシピを選択
3. レシピ詳細画面で以下を確認:
   - レシピ名
   - 材料一覧
   - 手順
   - YouTube URL
   - 在庫有無（ストック管理する材料の場合）
4. YouTube URLをクリック
5. YouTubeアプリが開くことを確認（外部アプリ）

**期待結果:**
- レシピ詳細情報が正しく表示される
- 在庫有無が正しく表示される
- YouTube URLが正しく動作する

### 3. ストック管理フロー

#### 3.1 ストック登録
**シナリオ:** ユーザーがストックを登録する

**テストフロー:**
1. ログイン
2. 「ストック登録」ボタンをクリック
3. ストック登録画面で以下を入力:
   - ストック名: 「ミートソース」
   - 種類: 「完成品」
   - 量: 「2食分」
   - 冷凍開始日: 今日
4. 「登録」ボタンをクリック
5. ストック一覧画面に遷移
6. 登録したストックが表示されることを確認

**期待結果:**
- ストックが正常に登録される
- ストック一覧に表示される
- ストック詳細画面で内容が確認できる

#### 3.2 ストック編集
**シナリオ:** ユーザーがストックを編集する

**テストフロー:**
1. ログイン
2. ストック一覧からストックを選択
3. ストック詳細画面で「編集」ボタンをクリック
4. ストック編集画面で量を変更
5. 「更新」ボタンをクリック
6. ストック詳細画面に遷移
7. 変更が反映されていることを確認

**期待結果:**
- ストックが正常に更新される
- 変更内容が反映される

#### 3.3 ストック削除
**シナリオ:** ユーザーがストックを削除する

**テストフロー:**
1. ログイン
2. ストック一覧からストックを選択
3. ストック詳細画面で「削除」ボタンをクリック
4. 削除確認ダイアログで「削除」をクリック
5. ストック一覧画面に遷移
6. 削除したストックが表示されないことを確認

**期待結果:**
- ストックが正常に削除される
- ストック一覧から削除される

#### 3.4 ストック詳細表示
**シナリオ:** ユーザーがストック詳細を確認する

**テストフロー:**
1. ログイン
2. ストック一覧からストックを選択
3. ストック詳細画面で以下を確認:
   - ストック名
   - 種類
   - 量
   - 冷凍開始日
   - このストックを使うレシピ一覧
4. レシピ一覧からレシピをクリック
5. レシピ詳細画面に遷移することを確認

**期待結果:**
- ストック詳細情報が正しく表示される
- 使用レシピ一覧が正しく表示される
- レシピ詳細画面への遷移が正常に動作する

#### 3.5 消費推奨アラート
**シナリオ:** ユーザーが消費推奨アラートを確認する

**テストフロー:**
1. ログイン
2. 1ヶ月以上経過したストックを登録（テストデータ）
3. ストック一覧画面を表示
4. 消費推奨アラートが表示されることを確認
5. アラートが目立つように表示されることを確認

**期待結果:**
- 1ヶ月以上経過したストックにアラートが表示される
- アラートが目立つように表示される

### 4. 検索・フィルターフロー

#### 4.1 ストック優先フィルター
**シナリオ:** ユーザーがストック優先フィルターを使用する

**テストフロー:**
1. ログイン
2. ストックを登録（完成品: ミートソース）
3. ホーム画面で「ストック優先フィルター」ボタンをクリック
4. レシピ一覧画面でフィルター結果を確認
5. ミートソースを使うレシピが表示されることを確認

**期待結果:**
- ストック優先フィルターが正常に動作する
- 適切なレシピが表示される

#### 4.2 キーワード検索
**シナリオ:** ユーザーがキーワード検索を使用する

**テストフロー:**
1. ログイン
2. レシピ一覧画面で検索ボックスに「ペペロンチーノ」と入力
3. 「検索」ボタンをクリック
4. 検索結果を確認
5. 「ペペロンチーノ」を含むレシピが表示されることを確認

**期待結果:**
- キーワード検索が正常に動作する
- 適切なレシピが表示される

### 5. 画面遷移フロー

#### 5.1 ホーム画面からの遷移
**シナリオ:** ユーザーがホーム画面から各画面に遷移する

**テストフロー:**
1. ログイン
2. ホーム画面で「レシピ一覧」ボタンをクリック
3. レシピ一覧画面に遷移することを確認
4. ホーム画面に戻る
5. ホーム画面で「ストック一覧」ボタンをクリック
6. ストック一覧画面に遷移することを確認

**期待結果:**
- ホーム画面からの遷移が正常に動作する

#### 5.2 ストックとレシピの相互導線
**シナリオ:** ユーザーがストックとレシピの相互導線を使用する

**テストフロー:**
1. ログイン
2. ストックを登録（完成品: ミートソース）
3. レシピを登録（ミートソースを使うレシピ）
4. ストック詳細画面で「このストックを使うレシピ一覧」を確認
5. レシピをクリック
6. レシピ詳細画面に遷移することを確認
7. レシピ詳細画面で材料のストックをクリック
8. ストック詳細画面に遷移することを確認

**期待結果:**
- ストックとレシピの相互導線が正常に動作する

### 6. アレンジレシピフロー（Phase 1.5）

#### 6.1 アレンジレシピ登録
**シナリオ:** ユーザーがアレンジレシピを登録する

**テストフロー:**
1. ログイン
2. 基本レシピを登録
3. レシピ詳細画面で「アレンジレシピを登録」ボタンをクリック
4. アレンジレシピ登録画面で以下を入力:
   - レシピ名: 「キャベツペペロンチーノ」
   - 親レシピ: 基本レシピを選択
   - 追加材料: 「キャベツ」
5. 「登録」ボタンをクリック
6. レシピ詳細画面に遷移
7. アレンジレシピ一覧に表示されることを確認

**期待結果:**
- アレンジレシピが正常に登録される
- 基本レシピとの関係が正しく保存される

#### 6.2 アレンジレシピ一覧表示
**シナリオ:** ユーザーがアレンジレシピ一覧を確認する

**テストフロー:**
1. ログイン
2. 基本レシピの詳細画面を表示
3. アレンジレシピ一覧を確認
4. アレンジレシピをクリック
5. アレンジレシピの詳細画面に遷移することを確認

**期待結果:**
- アレンジレシピ一覧が正しく表示される
- アレンジレシピ詳細画面への遷移が正常に動作する

## テスト環境の構成

### Docker Compose構成

```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/cooking_cycle_test
    depends_on:
      - db

  db:
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=cooking_cycle_test
    volumes:
      - postgres_test_data:/var/lib/postgresql/data

volumes:
  postgres_test_data:
```

### テストデータの管理方法

#### セットアップ
- 各テストの前にテストデータをセットアップ
- テストデータは独立している（他のテストに影響しない）

#### クリーンアップ
- 各テストの後にテストデータをクリーンアップ
- データベースをリセット

#### テストデータファイル
- `tests/fixtures/users.json`: テストユーザー
- `tests/fixtures/recipes.json`: テストレシピ
- `tests/fixtures/stocks.json`: テストストック
- `tests/fixtures/products.json`: テスト製品

## Playwrightのテスト構造

### ディレクトリ構成

```
tests/
  e2e/
    auth/
      login.spec.ts
      logout.spec.ts
    recipes/
      create.spec.ts
      update.spec.ts
      delete.spec.ts
      detail.spec.ts
    stocks/
      create.spec.ts
      update.spec.ts
      delete.spec.ts
      detail.spec.ts
    search/
      filter-by-stock.spec.ts
      keyword.spec.ts
    navigation/
      home.spec.ts
      stock-recipe-link.spec.ts
  fixtures/
    users.json
    recipes.json
    stocks.json
    products.json
  utils/
    setup.ts
    teardown.ts
    helpers.ts
```

### テストファイルの例

```typescript
import { test, expect } from '@playwright/test';

test.describe('レシピ登録', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン
    await page.goto('/');
    await page.click('text=ログイン');
    // Google認証のモック
  });

  test('レシピを登録できる', async ({ page }) => {
    // レシピ登録画面に遷移
    await page.click('text=レシピ登録');
    
    // フォームに入力
    await page.fill('input[name="name"]', 'ペペロンチーノ');
    await page.fill('textarea[name="instructions"]', '手順1\n手順2');
    
    // 登録ボタンをクリック
    await page.click('button[type="submit"]');
    
    // レシピ一覧画面に遷移
    await expect(page).toHaveURL('/recipes');
    
    // 登録したレシピが表示される
    await expect(page.locator('text=ペペロンチーノ')).toBeVisible();
  });
});
```

## テスト実行

### コマンド

```bash
# すべてのE2Eテストを実行
npm run test:e2e

# 特定のブラウザで実行
npm run test:e2e:chromium

# UIモードで実行
npm run test:e2e:ui

# デバッグモードで実行
npm run test:e2e:debug
```

### CI/CD統合

- GitHub Actionsで自動実行
- プルリクエスト時にテストを実行
- スクリーンショットと動画を保存

## テストカバレッジ

### カバレッジ目標
- **主要ユースケース:** 100%
- **画面遷移:** 100%
- **エラーケース:** 80%以上

### カバレッジ対象
- 認証フロー
- レシピ管理フロー
- ストック管理フロー
- 検索・フィルターフロー
- 画面遷移フロー
- アレンジレシピフロー（Phase 1.5）



