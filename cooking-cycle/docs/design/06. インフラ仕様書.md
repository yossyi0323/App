# インフラ仕様書

## 概要

ローカル開発環境とAWS本番環境のインフラ構成を定義します。

## ローカル開発環境

### Docker Compose構成

**ファイル:** `docker-compose.yml`

```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/cooking_cycle
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=development-secret
    depends_on:
      - db
    command: npm run dev

  db:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=cooking_cycle
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 環境変数

**ファイル:** `.env.local`

```
# データベース
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/cooking_cycle

# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=development-secret

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

### 構成図

```mermaid
flowchart LR
    A[開発者PC] --> B[Docker Compose]
    B --> C[Next.js App<br/>Port 3000]
    B --> D[PostgreSQL<br/>Port 5432]
    C --> D
```

## AWS本番環境構成

### アーキテクチャ概要

```mermaid
flowchart TD
    A[ユーザー] --> B[インターネット]
    B --> C[Route 53<br/>DNS]
    C --> D[CloudFront<br/>CDN]
    D --> E[Application Load Balancer]
    E --> F[EC2<br/>Next.js App]
    F --> G[RDS<br/>PostgreSQL]
    F --> H[S3<br/>静的ファイル]
    
    I[VPC] --> F
    I --> G
```

### VPC構成

#### VPC設定
- **CIDR:** 10.0.0.0/16
- **リージョン:** ap-northeast-1（東京）

#### サブネット構成

| サブネット名 | CIDR | 用途 | AZ |
|------------|------|------|-----|
| public-subnet-1a | 10.0.1.0/24 | パブリックサブネット | ap-northeast-1a |
| public-subnet-1c | 10.0.2.0/24 | パブリックサブネット | ap-northeast-1c |
| private-subnet-1a | 10.0.11.0/24 | プライベートサブネット | ap-northeast-1a |
| private-subnet-1c | 10.0.12.0/24 | プライベートサブネット | ap-northeast-1c |

#### インターネットゲートウェイ
- パブリックサブネットに接続

#### NATゲートウェイ
- プライベートサブネットからインターネットへのアクセス用
- パブリックサブネットに配置

### EC2インスタンス仕様

#### インスタンスタイプ
- **t3.micro**（Phase 1）
  - vCPU: 2
  - メモリ: 1 GB
  - ネットワークパフォーマンス: 最大5 Gbps
  - コスト: 低（個人利用に適している）

#### ストレージ
- **EBSボリューム:** 20 GB（gp3）
- **スナップショット:** 自動バックアップ（週次）

#### セキュリティグループ

**インバウンドルール:**
- HTTP (80): 0.0.0.0/0（ALB経由のみ）
- HTTPS (443): 0.0.0.0/0（ALB経由のみ）
- SSH (22): 管理者IPのみ

**アウトバウンドルール:**
- すべて許可

#### ユーザーデータ（初期化スクリプト）
- Node.js 20.xのインストール
- PM2のインストール
- アプリケーションのデプロイ

### RDSデータベース仕様

#### インスタンスタイプ
- **db.t3.micro**（Phase 1）
  - vCPU: 2
  - メモリ: 1 GB
  - ストレージ: 20 GB（gp3）

#### データベース設定
- **エンジン:** PostgreSQL 16
- **マルチAZ:** なし（個人利用のため、コスト削減）
- **バックアップ保持期間:** 7日間
- **自動バックアップ:** 有効（毎日3:00 JST）
- **メンテナンスウィンドウ:** 日曜 3:00-4:00 JST

#### セキュリティグループ
- **インバウンドルール:**
  - PostgreSQL (5432): EC2インスタンスのセキュリティグループのみ

#### パラメータグループ
- `timezone`: Asia/Tokyo
- `shared_preload_libraries`: pg_stat_statements

### S3バケット構成

#### バケット名
- `cooking-cycle-static`（静的ファイル用）
- `cooking-cycle-uploads`（アップロードファイル用、Phase 3以降）

#### 設定
- **バージョニング:** 有効
- **暗号化:** AES256
- **パブリックアクセス:** ブロック
- **ライフサイクルポリシー:** 30日後にIA（Infrequent Access）に移行

### CloudFront（CDN）

#### 配信元
- Application Load Balancer
- S3バケット（静的ファイル）

#### 設定
- **SSL証明書:** ACM（AWS Certificate Manager）
- **キャッシュポリシー:** CachingOptimized
- **価格クラス:** PriceClass_100（アジア太平洋のみ）

### Application Load Balancer（ALB）

#### 設定
- **スキーム:** インターネット向け
- **タイプ:** Application Load Balancer
- **リスナー:**
  - HTTP (80): HTTPSにリダイレクト
  - HTTPS (443): ターゲットグループに転送

#### ターゲットグループ
- **ターゲットタイプ:** インスタンス
- **プロトコル:** HTTP
- **ポート:** 3000
- **ヘルスチェック:**
  - パス: `/api/health`
  - 間隔: 30秒
  - タイムアウト: 5秒
  - 正常しきい値: 2
  - 異常しきい値: 2

### Route 53（DNS）

#### 設定
- **ホストゾーン:** 独自ドメイン（例: cooking-cycle.example.com）
- **レコードタイプ:** A（ALIAS）
- **ターゲット:** CloudFrontディストリビューション

### セキュリティ

#### IAMロール
- **EC2インスタンスロール:**
  - S3への読み書きアクセス
  - CloudWatch Logsへの書き込み
  - Systems Managerへのアクセス

#### セキュリティグループ
- 最小権限の原則に従って設定
- 必要なポートのみ開放

#### SSL/TLS
- **証明書:** ACM（AWS Certificate Manager）
- **プロトコル:** TLS 1.2以上
- **暗号化:** AES-256

### 監視・ログ

#### CloudWatch
- **メトリクス:**
  - EC2: CPU使用率、メモリ使用率、ネットワーク
  - RDS: CPU使用率、接続数、ストレージ使用率
  - ALB: リクエスト数、レスポンス時間、エラー率
- **アラーム:**
  - CPU使用率 > 80%
  - メモリ使用率 > 80%
  - エラー率 > 5%

#### CloudWatch Logs
- **ロググループ:**
  - `/aws/ec2/cooking-cycle-app`
  - `/aws/rds/cooking-cycle-db`

### バックアップ・災害復旧戦略

#### RDSバックアップ
- **自動バックアップ:** 毎日3:00 JST
- **保持期間:** 7日間
- **スナップショット:** 手動スナップショットも作成可能

#### EBSスナップショット
- **自動スナップショット:** 週次（日曜 2:00 JST）
- **保持期間:** 30日間

#### S3バージョニング
- **有効:** すべてのバケット
- **保持期間:** 30日間

#### 災害復旧手順
1. RDSスナップショットから復元
2. EBSスナップショットからEC2インスタンスを復元
3. アプリケーションを再デプロイ
4. 動作確認

### デプロイメント手順

#### 初回デプロイ
1. VPC、サブネット、インターネットゲートウェイ、NATゲートウェイを作成
2. セキュリティグループを作成
3. RDSインスタンスを作成
4. EC2インスタンスを作成
5. S3バケットを作成
6. CloudFrontディストリビューションを作成
7. ALBを作成
8. Route 53レコードを作成
9. アプリケーションをデプロイ

#### 通常のデプロイ
1. ローカルで開発・テスト
2. Gitにコミット・プッシュ
3. EC2インスタンスにSSH接続
4. アプリケーションを更新
5. PM2でアプリケーションを再起動
6. 動作確認

#### CI/CD（将来の拡張）
- GitHub Actionsを使用
- 自動デプロイパイプラインを構築

### コスト見積もり（月額）

| サービス | 仕様 | 月額（概算） |
|---------|------|------------|
| EC2 (t3.micro) | 24時間稼働 | 約1,000円 |
| RDS (db.t3.micro) | 24時間稼働 | 約2,000円 |
| EBS | 20 GB | 約200円 |
| S3 | 10 GB | 約250円 |
| CloudFront | 10 GB転送 | 約1,000円 |
| ALB | 24時間稼働 | 約1,500円 |
| Route 53 | ホストゾーン | 約50円 |
| **合計** | | **約6,000円** |

**注意:** 実際のコストは使用量によって変動します。

### スケーリング戦略

#### Phase 1
- 単一EC2インスタンス
- マルチAZなし
- 自動スケーリングなし

#### Phase 2以降
- 必要に応じてインスタンスタイプをアップグレード
- マルチAZの検討
- 自動スケーリングの検討

### セキュリティベストプラクティス

1. **最小権限の原則:** IAMロールは必要最小限の権限のみ
2. **ネットワーク分離:** プライベートサブネットにRDSを配置
3. **暗号化:** 転送中・保存時のデータを暗号化
4. **定期的な更新:** セキュリティパッチを適用
5. **監視:** CloudWatchで異常を検知
6. **バックアップ:** 定期的なバックアップを実施



