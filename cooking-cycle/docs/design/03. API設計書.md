# API設計書

## 基本方針

- **Next.js App Router**を使用
- **REST API**の設計原則に従う
- **認証・認可**はすべてのAPIエンドポイントで必須
- **エラーハンドリング**は統一された形式で返す

### Next.js App RouterとREST APIの使い分け

**設計方針:**
- **Phase 1**: REST APIエンドポイント（`/api/*`）を使用
- **理由**: PWAとしてオフライン動作や外部連携を強く意識するため、REST APIが適切
- **将来の拡張**: Phase 2以降で、開発効率を優先する場合はServer Actionsへの集約も検討可能

**REST APIの利点:**
- オフライン対応（Service Workerでキャッシュ可能）
- 外部連携（モバイルアプリなど）
- API仕様の明確化（OpenAPI/Swagger対応可能）

**Server Actionsの利点:**
- 開発効率の向上（APIエンドポイントを意識せずにDB操作可能）
- 型安全性の向上（TypeScriptとの親和性）
- コードの簡潔性

**実装方針:**
- Phase 1ではREST APIを基本とする
- Phase 2以降で、必要に応じてServer Actionsへの移行を検討

## 認証・認可

### 認証方式
- **Google OAuth 2.0**を使用
- セッション管理はNext.jsのセッション機能を使用

### 認可
- すべてのAPIエンドポイントで認証が必要
- ユーザーは自分のデータのみアクセス可能
- リソースの所有権チェックを実装

## エラーハンドリング

### エラーレスポンス形式

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ",
    "details": {}
  }
}
```

### エラーコード一覧

| コード | HTTPステータス | 説明 |
|--------|--------------|------|
| UNAUTHORIZED | 401 | 認証が必要 |
| FORBIDDEN | 403 | アクセス権限がない |
| NOT_FOUND | 404 | リソースが見つからない |
| VALIDATION_ERROR | 400 | バリデーションエラー |
| INTERNAL_ERROR | 500 | サーバー内部エラー |

## Next.js App Routerのルーティング設計

### ページルート

```
/app
  /recipes
    /page.tsx              # レシピ一覧
    /[id]
      /page.tsx            # レシピ詳細
      /edit
        /page.tsx          # レシピ編集
    /new
      /page.tsx            # レシピ登録
  /stocks
    /page.tsx              # ストック一覧
    /[id]
      /page.tsx            # ストック詳細
      /edit
        /page.tsx          # ストック編集
    /new
      /page.tsx            # ストック登録
  /page.tsx                # ホーム画面
  /api
    /recipes
      /route.ts            # レシピAPI
      /[id]
        /route.ts          # レシピ詳細API
    /stocks
      /route.ts            # ストックAPI
      /[id]
        /route.ts          # ストック詳細API
    /auth
      /google
        /route.ts          # Google認証
      /logout
        /route.ts          # ログアウト
```

## REST APIエンドポイント

### レシピ管理API

#### GET /api/recipes
レシピ一覧を取得

**リクエスト:**
- Query Parameters:
  - `page` (optional): ページ番号（デフォルト: 1）
  - `limit` (optional): 1ページあたりの件数（デフォルト: 20）
  - `sort` (optional): ソート条件（`created_at`, `name`など）
  - `order` (optional): ソート順（`asc`, `desc`、デフォルト: `desc`）

**レスポンス:**
```json
{
  "recipes": [
    {
      "recipe_id": "uuid",
      "name": "レシピ名",
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### GET /api/recipes/[id]
レシピ詳細を取得

**リクエスト:**
- Path Parameters:
  - `id`: レシピID

**レスポンス:**
```json
{
  "recipe": {
    "recipe_id": "uuid",
    "user_id": "uuid",
    "parent_recipe_id": "uuid",
    "name": "レシピ名",
    "recipe_url": "https://youtube.com/...",
    "instructions_text": "手順1\n手順2",
    "components": [
      {
        "component_id": "uuid",
        "product_id": "uuid",
        "product_name": "製品名",
        "ingredient_name": null,
        "input_type": "PRODUCT",
        "quantity_memo": "2食分",
        "is_optional": false,
        "required_state_transition_id": "uuid",
        "required_state_transition_name": "洗う → 水気なし",
        "stock_status": "AVAILABLE" // 在庫有無
      }
    ],
    "outputs": [
      {
        "output_id": "uuid",
        "product_id": "uuid",
        "product_name": "製品名",
        "quantity_memo": "2食分",
        "is_main_output": true
      }
    ],
    "arrange_recipes": [
      {
        "recipe_id": "uuid",
        "name": "アレンジレシピ名"
      }
    ],
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
}
```

#### POST /api/recipes
レシピを登録

**リクエスト:**
```json
{
  "name": "レシピ名",
  "parent_recipe_id": "uuid",
  "recipe_url": "https://youtube.com/...",
  "instructions_text": "手順1\n手順2",
  "components": [
    {
      "product_id": "uuid",
      "ingredient_name": null,
      "input_type": "PRODUCT",
      "quantity_memo": "2食分",
      "is_optional": false,
      "required_state_transition_id": "uuid"
    }
  ],
  "outputs": [
    {
      "product_id": "uuid",
      "quantity_memo": "2食分",
      "is_main_output": true
    }
  ]
}
```

**レスポンス:**
```json
{
  "recipe_id": "uuid",
  "message": "レシピを登録しました"
}
```

#### PUT /api/recipes/[id]
レシピを更新

**リクエスト:**
- Path Parameters:
  - `id`: レシピID
- Body: POST /api/recipesと同じ

**レスポンス:**
```json
{
  "recipe_id": "uuid",
  "message": "レシピを更新しました"
}
```

#### DELETE /api/recipes/[id]
レシピを削除

**リクエスト:**
- Path Parameters:
  - `id`: レシピID

**レスポンス:**
```json
{
  "message": "レシピを削除しました"
}
```

### ストック管理API

#### GET /api/stocks
ストック一覧を取得

**リクエスト:**
- Query Parameters:
  - `page` (optional): ページ番号（デフォルト: 1）
  - `limit` (optional): 1ページあたりの件数（デフォルト: 20）
  - `sort` (optional): ソート条件（`stocked_since_date`, `name`など）
  - `order` (optional): ソート順（`asc`, `desc`、デフォルト: `desc`）
  - `type` (optional): フィルター条件（`raw_material`, `intermediate`, `final_dish`など）

**レスポンス:**
```json
{
  "stocks": [
    {
      "user_id": "uuid",
      "product_id": "uuid",
      "product_name": "製品名",
      "product_type": "final_dish",
      "status": "AVAILABLE",
      "quantity_memo": "2食分",
      "state_memo": "水気なし",
      "ingredient_id": "uuid",
      "ingredient_name": "葉野菜",
      "state_transition_id": "uuid",
      "state_transition_name": "洗う → 水気なし",
      "stocked_since_date": "2025-01-01T00:00:00Z",
      "created_from_recipe_id": "uuid",
      "created_from_recipe_name": "レシピ名",
      "needs_alert": true, // 1ヶ月以上経過
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### GET /api/stocks/[id]
ストック詳細を取得

**リクエスト:**
- Path Parameters:
  - `id`: product_id

**レスポンス:**
```json
{
  "stock": {
    "user_id": "uuid",
    "product_id": "uuid",
    "product_name": "製品名",
    "product_type": "final_dish",
    "status": "AVAILABLE",
    "quantity_memo": "2食分",
    "state_memo": "水気なし",
    "ingredient_id": "uuid",
    "ingredient_name": "葉野菜",
    "state_transition_id": "uuid",
    "state_transition_name": "洗う → 水気なし",
    "stocked_since_date": "2025-01-01T00:00:00Z",
    "created_from_recipe_id": "uuid",
    "created_from_recipe_name": "レシピ名",
    "used_in_recipes": [
      {
        "recipe_id": "uuid",
        "name": "レシピ名"
      }
    ],
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
}
```

#### POST /api/stocks
ストックを登録

**リクエスト:**
```json
{
  "product_id": "uuid",
  "product_name": "製品名",
  "product_type": "final_dish",
  "status": "AVAILABLE",
  "quantity_memo": "2食分",
  "state_memo": "水気なし",
  "stocked_since_date": "2025-01-01T00:00:00Z",
  "created_from_recipe_id": "uuid",
  "ingredient_id": "uuid",
  "state_transition_id": "uuid"
}
```

**注意:**
- `state_memo`: Phase 1で使用（自由入力）
- `ingredient_id`, `state_transition_id`: Phase 2以降で使用（状態遷移から選択）

**レスポンス:**
```json
{
  "user_id": "uuid",
  "product_id": "uuid",
  "message": "ストックを登録しました"
}
```

#### PUT /api/stocks/[id]
ストックを更新

**リクエスト:**
- Path Parameters:
  - `id`: product_id
- Body: POST /api/stocksと同じ

**レスポンス:**
```json
{
  "user_id": "uuid",
  "product_id": "uuid",
  "message": "ストックを更新しました"
}
```

#### DELETE /api/stocks/[id]
ストックを削除

**リクエスト:**
- Path Parameters:
  - `id`: product_id

**レスポンス:**
```json
{
  "message": "ストックを削除しました"
}
```

### 検索・フィルターAPI

#### GET /api/recipes/search
レシピを検索

**リクエスト:**
- Query Parameters:
  - `keyword` (optional): キーワード検索
  - `tag` (optional): タグ検索（Phase 2以降）
  - `tag_operator` (optional): タグ検索の演算子（`AND`, `OR`, `NOT`、Phase 2以降）
  - `filter_by_stock` (optional): ストック優先フィルター（`true`/`false`）
  - `page` (optional): ページ番号
  - `limit` (optional): 1ページあたりの件数

**レスポンス:**
```json
{
  "recipes": [
    {
      "recipe_id": "uuid",
      "name": "レシピ名",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### GET /api/recipes/filter-by-stock
ストック優先フィルター

**リクエスト:**
- Query Parameters:
  - `page` (optional): ページ番号
  - `limit` (optional): 1ページあたりの件数

**レスポンス:**
```json
{
  "recipes": [
    {
      "recipe_id": "uuid",
      "name": "レシピ名",
      "matched_stocks": [
        {
          "product_id": "uuid",
          "product_name": "製品名",
          "product_type": "final_dish"
        }
      ],
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

### 認証API

#### GET /api/auth/google
Google認証の開始

**リクエスト:**
- なし

**レスポンス:**
- Google OAuth認証ページにリダイレクト

#### GET /api/auth/google/callback
Google認証のコールバック

**リクエスト:**
- Query Parameters:
  - `code`: OAuth認証コード

**レスポンス:**
- セッションを設定してホーム画面にリダイレクト

#### POST /api/auth/logout
ログアウト

**リクエスト:**
- なし

**レスポンス:**
```json
{
  "message": "ログアウトしました"
}
```

### 製品カタログAPI（内部使用）

#### GET /api/products
製品一覧を取得（検索・登録時に使用）

**リクエスト:**
- Query Parameters:
  - `keyword` (optional): キーワード検索
  - `type` (optional): 製品タイプでフィルター
  - `is_stockable` (optional): ストック管理対象でフィルター

**レスポンス:**
```json
{
  "products": [
    {
      "id": "uuid",
      "name": "製品名",
      "type": "final_dish",
      "is_stockable": true
    }
  ]
}
```

#### POST /api/products
製品を登録（ストック登録時に自動的に作成される）

**リクエスト:**
```json
{
  "name": "製品名",
  "type": "final_dish",
  "is_stockable": true
}
```

**レスポンス:**
```json
{
  "id": "uuid",
  "message": "製品を登録しました"
}
```

### 食材マスタAPI（Phase 2以降）

#### GET /api/ingredients
食材一覧を取得

**リクエスト:**
- Query Parameters:
  - `keyword` (optional): キーワード検索
  - `category` (optional): 食材カテゴリでフィルター

**レスポンス:**
```json
{
  "ingredients": [
    {
      "id": "uuid",
      "name": "食材名",
      "category": "野菜類"
    }
  ]
}
```

#### POST /api/ingredients
食材を登録

**リクエスト:**
```json
{
  "name": "食材名",
  "category": "野菜類"
}
```

**レスポンス:**
```json
{
  "id": "uuid",
  "message": "食材を登録しました"
}
```

### 処理マスタAPI（Phase 2以降）

#### GET /api/processes
処理一覧を取得

**リクエスト:**
- Query Parameters:
  - `keyword` (optional): キーワード検索
  - `category` (optional): 処理カテゴリでフィルター

**レスポンス:**
```json
{
  "processes": [
    {
      "id": "uuid",
      "name": "処理名",
      "description": "処理の説明",
      "category": "加熱",
      "parameters": {
        "tool": "フライパン",
        "temperature": "中火",
        "time": "5分"
      }
    }
  ]
}
```

#### POST /api/processes
処理を登録

**リクエスト:**
```json
{
  "name": "処理名",
  "description": "処理の説明",
  "category": "加熱",
  "parameters": {
    "tool": "フライパン",
    "temperature": "中火",
    "time": "5分"
  }
}
```

**レスポンス:**
```json
{
  "id": "uuid",
  "message": "処理を登録しました"
}
```

### 状態遷移API（Phase 2以降）

#### GET /api/ingredient-state-transitions
状態遷移一覧を取得

**リクエスト:**
- Query Parameters:
  - `ingredient_id` (optional): 食材IDでフィルター
  - `process_id` (optional): 処理IDでフィルター

**レスポンス:**
```json
{
  "state_transitions": [
    {
      "id": "uuid",
      "ingredient_id": "uuid",
      "ingredient_name": "葉野菜",
      "process_id": "uuid",
      "process_name": "洗う",
      "output_state_name": "水気あり",
      "output_state_alias": null
    }
  ]
}
```

#### POST /api/ingredient-state-transitions
状態遷移を登録

**リクエスト:**
```json
{
  "ingredient_id": "uuid",
  "process_id": "uuid",
  "output_state_name": "水気あり",
  "output_state_alias": null
}
```

**レスポンス:**
```json
{
  "id": "uuid",
  "message": "状態遷移を登録しました"
}
```

### レシピの循環参照検出API（Phase 2以降）

#### GET /api/recipes/[id]/verify-chain
レシピの依存関係チェーンを検証

**リクエスト:**
- Path Parameters:
  - `id`: レシピID

**レスポンス:**
```json
{
  "recipe_id": "uuid",
  "is_valid": true,
  "has_circular_dependency": false,
  "dependency_chain": [
    {
      "recipe_id": "uuid",
      "recipe_name": "ポトフ",
      "depends_on": []
    },
    {
      "recipe_id": "uuid",
      "recipe_name": "カレー",
      "depends_on": ["ポトフ"]
    }
  ],
  "errors": []
}
```

#### GET /api/recipes/[id]/dependency-graph
レシピの依存グラフを取得（Phase 3以降）

**リクエスト:**
- Path Parameters:
  - `id`: レシピID

**レスポンス:**
```json
{
  "recipe_id": "uuid",
  "recipe_name": "カレー",
  "dependency_graph": {
    "nodes": [
      {
        "id": "uuid",
        "name": "カレー",
        "type": "recipe"
      },
      {
        "id": "uuid",
        "name": "ポトフ",
        "type": "recipe"
      }
    ],
    "edges": [
      {
        "from": "uuid",
        "to": "uuid",
        "type": "depends_on"
      }
    ]
  }
}
```

### 在庫の整合性テストAPI（Phase 2以降）

#### POST /api/recipes/[id]/simulate-consumption
レシピ実行時の在庫消費をシミュレーション（Dry Run）

**リクエスト:**
- Path Parameters:
  - `id`: レシピID
- Body:
```json
{
  "portions": 4,
  "dry_run": true
}
```

**レスポンス:**
```json
{
  "recipe_id": "uuid",
  "portions": 4,
  "simulation_result": {
    "can_execute": true,
    "stock_consumption": [
      {
        "stock_id": "uuid",
        "stock_name": "材料1",
        "current_quantity": "2食分",
        "required_quantity": "4食分",
        "after_quantity": "不足"
      }
    ],
    "output_generation": [
      {
        "product_id": "uuid",
        "product_name": "完成品1",
        "quantity": "4食分"
      }
    ],
    "errors": []
  }
}
```

## バリデーション

### Phase別のバリデーション戦略

**重要**: Phase 1とPhase 2でバリデーションロジックが異なるため、環境・フェーズによる切り替えが必要。

**実装方針:**
- Phase 1: Phase 2用のカラム（`ingredient_id`、`state_transition_id`、`required_state_transition_id`）は**任意**として扱う
- Phase 2: Phase 2用のカラムのバリデーションを有効化
- バリデーションロジックは環境変数や設定ファイルで制御可能にする

**注意点:**
- Phase 1のフロントエンドからPhase 2用のカラムが送られない場合でもエラーにならないようにする
- Phase 2のフロントエンドからPhase 2用のカラムが送られない場合は、適切なエラーメッセージを返す

### レシピ登録・更新時のバリデーション

**Phase 1:**
- `name`: 必須、1文字以上255文字以下
- `instructions_text`: 必須、1文字以上
- `components`: 必須、1件以上
  - `input_type`: 必須、`PRODUCT`または`TEXT_INPUT`
  - `product_id`: `input_type`が`PRODUCT`の場合必須
  - `ingredient_name`: `input_type`が`TEXT_INPUT`の場合必須
  - `required_state_transition_id`: 任意（Phase 2以降）
- `outputs`: 必須、1件以上
  - `product_id`: 必須
  - `is_main_output`: 必須、少なくとも1件は`true`

**Phase 2以降:**
- Phase 1のバリデーションに加えて、以下を追加
  - `components[].required_state_transition_id`: 任意、指定されている場合はINGREDIENT_STATE_TRANSITIONSテーブルに存在する必要がある

### ストック登録・更新時のバリデーション

- `product_name`: 必須、1文字以上255文字以下
- `product_type`: 必須、`raw_material`, `intermediate`, `final_dish`, `seasoning`, `other`のいずれか
- `status`: 必須、`AVAILABLE`, `NEED_REFILL`, `NO_REFILL`のいずれか
- `stocked_since_date`: 必須、有効な日時
- `state_memo`: Phase 1で使用（任意、TEXT型）
- `ingredient_id`: Phase 2以降で使用（任意、UUID型）
- `state_transition_id`: Phase 2以降で使用（任意、UUID型、`ingredient_id`が指定されている場合は必須）

### 食材マスタ登録・更新時のバリデーション（Phase 2以降）

- `name`: 必須、1文字以上255文字以下
- `category`: 任意、50文字以下

### 処理マスタ登録・更新時のバリデーション（Phase 2以降）

- `name`: 必須、1文字以上255文字以下
- `description`: 任意、TEXT型
- `category`: 任意、50文字以下
- `parameters`: 任意、JSONB型

### 状態遷移登録・更新時のバリデーション（Phase 2以降）

- `ingredient_id`: 必須、UUID型、INGREDIENTSテーブルに存在する必要がある
- `process_id`: 必須、UUID型、PROCESSESテーブルに存在する必要がある
- `output_state_name`: 必須、1文字以上255文字以下
- `output_state_alias`: 任意、255文字以下
- 同じ`ingredient_id`と`process_id`の組み合わせは1つまで（UNIQUE制約）

## セキュリティ

### 認証チェック
- すべてのAPIエンドポイントで認証が必要
- 認証されていないリクエストは401エラーを返す

### 認可チェック
- ユーザーは自分のデータのみアクセス可能
- リソースの所有権をチェック（`user_id`の確認）
- 所有権がないリクエストは403エラーを返す

### 入力サニタイゼーション
- SQLインジェクション対策：プリペアドステートメントを使用
- XSS対策：入力値をサニタイズ
- CSRF対策：Next.jsのCSRF保護機能を使用

## パフォーマンス

### ページネーション
- 一覧取得APIはすべてページネーション対応
- デフォルトは20件、最大100件まで

### インデックス
- 検索頻度の高いカラムにインデックスを設定
- 複合インデックスも必要に応じて追加

### キャッシュ
- 製品カタログはキャッシュ可能
- レシピ一覧は適切なキャッシュ戦略を検討



