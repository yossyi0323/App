# API設計書

## 基本方針

- **Next.js App Router**を使用
- **REST API**の設計原則に従う
- **認証・認可**はすべてのAPIエンドポイントで必須
- **エラーハンドリング**は統一された形式で返す

## 認証・認可

### 認証方式
- **Google OAuth 2.0**を使用
- セッション管理はNext.jsのセッション機能を使用

### 認可
- すべてのAPIエンドポイントで認証が必要
- ユーザーは自分のデータのみアクセス可能
- リソースの所有権チェックを実装

## エラーハンドリング

### エラーレスポンス形式

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ",
    "details": {}
  }
}
```

### エラーコード一覧

| コード | HTTPステータス | 説明 |
|--------|--------------|------|
| UNAUTHORIZED | 401 | 認証が必要 |
| FORBIDDEN | 403 | アクセス権限がない |
| NOT_FOUND | 404 | リソースが見つからない |
| VALIDATION_ERROR | 400 | バリデーションエラー |
| INTERNAL_ERROR | 500 | サーバー内部エラー |

## Next.js App Routerのルーティング設計

### ページルート

```
/app
  /recipes
    /page.tsx              # レシピ一覧
    /[id]
      /page.tsx            # レシピ詳細
      /edit
        /page.tsx          # レシピ編集
    /new
      /page.tsx            # レシピ登録
  /stocks
    /page.tsx              # ストック一覧
    /[id]
      /page.tsx            # ストック詳細
      /edit
        /page.tsx          # ストック編集
    /new
      /page.tsx            # ストック登録
  /page.tsx                # ホーム画面
  /api
    /recipes
      /route.ts            # レシピAPI
      /[id]
        /route.ts          # レシピ詳細API
    /stocks
      /route.ts            # ストックAPI
      /[id]
        /route.ts          # ストック詳細API
    /auth
      /google
        /route.ts          # Google認証
      /logout
        /route.ts          # ログアウト
```

## REST APIエンドポイント

### レシピ管理API

#### GET /api/recipes
レシピ一覧を取得

**リクエスト:**
- Query Parameters:
  - `page` (optional): ページ番号（デフォルト: 1）
  - `limit` (optional): 1ページあたりの件数（デフォルト: 20）
  - `sort` (optional): ソート条件（`created_at`, `name`など）
  - `order` (optional): ソート順（`asc`, `desc`、デフォルト: `desc`）

**レスポンス:**
```json
{
  "recipes": [
    {
      "recipe_id": "uuid",
      "name": "レシピ名",
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### GET /api/recipes/[id]
レシピ詳細を取得

**リクエスト:**
- Path Parameters:
  - `id`: レシピID

**レスポンス:**
```json
{
  "recipe": {
    "recipe_id": "uuid",
    "user_id": "uuid",
    "parent_recipe_id": "uuid",
    "name": "レシピ名",
    "recipe_url": "https://youtube.com/...",
    "instructions_text": "手順1\n手順2",
    "components": [
      {
        "component_id": "uuid",
        "product_id": "uuid",
        "product_name": "製品名",
        "ingredient_name": null,
        "input_type": "PRODUCT",
        "quantity_memo": "2食分",
        "is_optional": false,
        "stock_status": "AVAILABLE" // 在庫有無
      }
    ],
    "outputs": [
      {
        "output_id": "uuid",
        "product_id": "uuid",
        "product_name": "製品名",
        "quantity_memo": "2食分",
        "is_main_output": true
      }
    ],
    "arrange_recipes": [
      {
        "recipe_id": "uuid",
        "name": "アレンジレシピ名"
      }
    ],
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
}
```

#### POST /api/recipes
レシピを登録

**リクエスト:**
```json
{
  "name": "レシピ名",
  "parent_recipe_id": "uuid",
  "recipe_url": "https://youtube.com/...",
  "instructions_text": "手順1\n手順2",
  "components": [
    {
      "product_id": "uuid",
      "ingredient_name": null,
      "input_type": "PRODUCT",
      "quantity_memo": "2食分",
      "is_optional": false
    }
  ],
  "outputs": [
    {
      "product_id": "uuid",
      "quantity_memo": "2食分",
      "is_main_output": true
    }
  ]
}
```

**レスポンス:**
```json
{
  "recipe_id": "uuid",
  "message": "レシピを登録しました"
}
```

#### PUT /api/recipes/[id]
レシピを更新

**リクエスト:**
- Path Parameters:
  - `id`: レシピID
- Body: POST /api/recipesと同じ

**レスポンス:**
```json
{
  "recipe_id": "uuid",
  "message": "レシピを更新しました"
}
```

#### DELETE /api/recipes/[id]
レシピを削除

**リクエスト:**
- Path Parameters:
  - `id`: レシピID

**レスポンス:**
```json
{
  "message": "レシピを削除しました"
}
```

### ストック管理API

#### GET /api/stocks
ストック一覧を取得

**リクエスト:**
- Query Parameters:
  - `page` (optional): ページ番号（デフォルト: 1）
  - `limit` (optional): 1ページあたりの件数（デフォルト: 20）
  - `sort` (optional): ソート条件（`stocked_since_date`, `name`など）
  - `order` (optional): ソート順（`asc`, `desc`、デフォルト: `desc`）
  - `type` (optional): フィルター条件（`raw_material`, `intermediate`, `final_dish`など）

**レスポンス:**
```json
{
  "stocks": [
    {
      "user_id": "uuid",
      "product_id": "uuid",
      "product_name": "製品名",
      "product_type": "final_dish",
      "status": "AVAILABLE",
      "quantity_memo": "2食分",
      "stocked_since_date": "2025-01-01T00:00:00Z",
      "created_from_recipe_id": "uuid",
      "created_from_recipe_name": "レシピ名",
      "needs_alert": true, // 1ヶ月以上経過
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### GET /api/stocks/[id]
ストック詳細を取得

**リクエスト:**
- Path Parameters:
  - `id`: product_id

**レスポンス:**
```json
{
  "stock": {
    "user_id": "uuid",
    "product_id": "uuid",
    "product_name": "製品名",
    "product_type": "final_dish",
    "status": "AVAILABLE",
    "quantity_memo": "2食分",
    "stocked_since_date": "2025-01-01T00:00:00Z",
    "created_from_recipe_id": "uuid",
    "created_from_recipe_name": "レシピ名",
    "used_in_recipes": [
      {
        "recipe_id": "uuid",
        "name": "レシピ名"
      }
    ],
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
}
```

#### POST /api/stocks
ストックを登録

**リクエスト:**
```json
{
  "product_id": "uuid",
  "product_name": "製品名",
  "product_type": "final_dish",
  "status": "AVAILABLE",
  "quantity_memo": "2食分",
  "stocked_since_date": "2025-01-01T00:00:00Z",
  "created_from_recipe_id": "uuid"
}
```

**レスポンス:**
```json
{
  "user_id": "uuid",
  "product_id": "uuid",
  "message": "ストックを登録しました"
}
```

#### PUT /api/stocks/[id]
ストックを更新

**リクエスト:**
- Path Parameters:
  - `id`: product_id
- Body: POST /api/stocksと同じ

**レスポンス:**
```json
{
  "user_id": "uuid",
  "product_id": "uuid",
  "message": "ストックを更新しました"
}
```

#### DELETE /api/stocks/[id]
ストックを削除

**リクエスト:**
- Path Parameters:
  - `id`: product_id

**レスポンス:**
```json
{
  "message": "ストックを削除しました"
}
```

### 検索・フィルターAPI

#### GET /api/recipes/search
レシピを検索

**リクエスト:**
- Query Parameters:
  - `keyword` (optional): キーワード検索
  - `tag` (optional): タグ検索（Phase 2以降）
  - `tag_operator` (optional): タグ検索の演算子（`AND`, `OR`, `NOT`、Phase 2以降）
  - `filter_by_stock` (optional): ストック優先フィルター（`true`/`false`）
  - `page` (optional): ページ番号
  - `limit` (optional): 1ページあたりの件数

**レスポンス:**
```json
{
  "recipes": [
    {
      "recipe_id": "uuid",
      "name": "レシピ名",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### GET /api/recipes/filter-by-stock
ストック優先フィルター

**リクエスト:**
- Query Parameters:
  - `page` (optional): ページ番号
  - `limit` (optional): 1ページあたりの件数

**レスポンス:**
```json
{
  "recipes": [
    {
      "recipe_id": "uuid",
      "name": "レシピ名",
      "matched_stocks": [
        {
          "product_id": "uuid",
          "product_name": "製品名",
          "product_type": "final_dish"
        }
      ],
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

### 認証API

#### GET /api/auth/google
Google認証の開始

**リクエスト:**
- なし

**レスポンス:**
- Google OAuth認証ページにリダイレクト

#### GET /api/auth/google/callback
Google認証のコールバック

**リクエスト:**
- Query Parameters:
  - `code`: OAuth認証コード

**レスポンス:**
- セッションを設定してホーム画面にリダイレクト

#### POST /api/auth/logout
ログアウト

**リクエスト:**
- なし

**レスポンス:**
```json
{
  "message": "ログアウトしました"
}
```

### 製品カタログAPI（内部使用）

#### GET /api/products
製品一覧を取得（検索・登録時に使用）

**リクエスト:**
- Query Parameters:
  - `keyword` (optional): キーワード検索
  - `type` (optional): 製品タイプでフィルター
  - `is_stockable` (optional): ストック管理対象でフィルター

**レスポンス:**
```json
{
  "products": [
    {
      "id": "uuid",
      "name": "製品名",
      "type": "final_dish",
      "is_stockable": true
    }
  ]
}
```

#### POST /api/products
製品を登録（ストック登録時に自動的に作成される）

**リクエスト:**
```json
{
  "name": "製品名",
  "type": "final_dish",
  "is_stockable": true
}
```

**レスポンス:**
```json
{
  "id": "uuid",
  "message": "製品を登録しました"
}
```

## バリデーション

### レシピ登録・更新時のバリデーション

- `name`: 必須、1文字以上255文字以下
- `instructions_text`: 必須、1文字以上
- `components`: 必須、1件以上
  - `input_type`: 必須、`PRODUCT`または`TEXT_INPUT`
  - `product_id`: `input_type`が`PRODUCT`の場合必須
  - `ingredient_name`: `input_type`が`TEXT_INPUT`の場合必須
- `outputs`: 必須、1件以上
  - `product_id`: 必須
  - `is_main_output`: 必須、少なくとも1件は`true`

### ストック登録・更新時のバリデーション

- `product_name`: 必須、1文字以上255文字以下
- `product_type`: 必須、`raw_material`, `intermediate`, `final_dish`, `seasoning`, `other`のいずれか
- `status`: 必須、`AVAILABLE`, `NEED_REFILL`, `NO_REFILL`のいずれか
- `stocked_since_date`: 必須、有効な日時

## セキュリティ

### 認証チェック
- すべてのAPIエンドポイントで認証が必要
- 認証されていないリクエストは401エラーを返す

### 認可チェック
- ユーザーは自分のデータのみアクセス可能
- リソースの所有権をチェック（`user_id`の確認）
- 所有権がないリクエストは403エラーを返す

### 入力サニタイゼーション
- SQLインジェクション対策：プリペアドステートメントを使用
- XSS対策：入力値をサニタイズ
- CSRF対策：Next.jsのCSRF保護機能を使用

## パフォーマンス

### ページネーション
- 一覧取得APIはすべてページネーション対応
- デフォルトは20件、最大100件まで

### インデックス
- 検索頻度の高いカラムにインデックスを設定
- 複合インデックスも必要に応じて追加

### キャッシュ
- 製品カタログはキャッシュ可能
- レシピ一覧は適切なキャッシュ戦略を検討



