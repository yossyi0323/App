# テーブル定義書

## データベース概要

- **データベース名:** cooking_cycle
- **エンジン:** PostgreSQL
- **文字コード:** UTF-8
- **照合順序:** C

## テーブル一覧

1. USERS（ユーザー）
2. PRODUCTS（製品カタログ）
3. RECIPES（レシピ）
4. RECIPE_COMPONENTS（レシピの材料）
5. RECIPE_OUTPUTS（レシピのアウトプット）
6. STOCKS（ストック）
7. INGREDIENTS（食材マスタ）- Phase 2以降
8. PROCESSES（処理マスタ）- Phase 2以降
9. INGREDIENT_STATE_TRANSITIONS（状態遷移）- Phase 2以降

## 1. USERS（ユーザー）

### テーブル概要
ユーザー情報を管理するテーブル。

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| user_id | UUID | PRIMARY KEY | ユーザーID |
| email | VARCHAR(255) | NOT NULL, UNIQUE | メールアドレス（Google認証から取得） |
| name | VARCHAR(255) | NOT NULL | ユーザー名（Google認証から取得） |
| picture_url | VARCHAR(500) | | プロフィール画像URL（Google認証から取得） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `user_id`
- UNIQUE: `email`

### リレーション
- `RECIPES.user_id` → `USERS.user_id` (1対多)
- `STOCKS.user_id` → `USERS.user_id` (1対多)

## 2. PRODUCTS（製品カタログ）

### テーブル概要
材料・中間生成物・完成品・調味料のカタログ（概念）。ストックの種類（完成品/中間成果物/食材）を管理する。

**マスタデータのスコープ:**
- **基本方針**: ユーザーごとのプライベートマスタ（Phase 1）
- **将来の拡張**: Phase 2以降でシステム共通マスタ（`is_public = true`）とユーザーカスタムマスタ（`is_public = false`）の両方をサポートする可能性を考慮
- **設計方針**: Phase 1では`user_id`を追加せず、ユーザーごとに独立したマスタとして扱う（将来的に`user_id`カラムを追加可能な設計）

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY | 製品ID |
| name | VARCHAR(255) | NOT NULL | 製品名（例: 鶏もも肉, 塩コショウ, ミートソース, 冷凍ご飯） |
| type | VARCHAR(50) | NOT NULL | 製品タイプ（raw_material, intermediate, final_dish, seasoning, other） |
| is_stockable | BOOLEAN | NOT NULL, DEFAULT false | 冷凍庫ストック管理の対象か |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

**将来の拡張（Phase 2以降）:**
- `user_id` (UUID, FOREIGN KEY): ユーザーID（ユーザーごとのプライベートマスタ）
- `is_public` (BOOLEAN): システム共通マスタか（`true`の場合、全ユーザーで共有）

### インデックス
- PRIMARY KEY: `id`
- INDEX: `name`（検索用）
- INDEX: `type`（フィルター用）
- INDEX: `is_stockable`（フィルター用）

### リレーション
- `RECIPE_COMPONENTS.product_id` → `PRODUCTS.id` (多対1)
- `RECIPE_OUTPUTS.product_id` → `PRODUCTS.id` (多対1)
- `STOCKS.product_id` → `PRODUCTS.id` (多対1)

### 製品タイプの定義
- `raw_material`: 食材（ひき肉の小分けなど）
- `intermediate`: 中間成果物（肉のつけ置きなど）
- `final_dish`: 完成品（ミートソース、カレーなど）
- `seasoning`: 調味料（塩コショウなど、ストック管理しない）
- `other`: その他

## 3. RECIPES（レシピ）

### テーブル概要
レシピ情報を管理するテーブル。基本レシピとアレンジレシピの両方を管理。

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| recipe_id | UUID | PRIMARY KEY | レシピID |
| user_id | UUID | NOT NULL, FOREIGN KEY | レシピの所有者 |
| parent_recipe_id | UUID | FOREIGN KEY | 複製元のレシピID（アレンジレシピの場合、継承ロジックなし） |
| name | VARCHAR(255) | NOT NULL | レシピ名 |
| recipe_url | VARCHAR(500) | | YouTube URL |
| instructions_text | TEXT | NOT NULL | 手順（テキスト、改行区切り） |
| deleted_at | TIMESTAMP | | 論理削除日時（NULLの場合は有効） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `recipe_id`
- FOREIGN KEY: `user_id` → `USERS.user_id`
- FOREIGN KEY: `parent_recipe_id` → `RECIPES.recipe_id`（自己参照）
- INDEX: `user_id`（ユーザーごとのレシピ検索用）
- INDEX: `parent_recipe_id`（アレンジレシピ検索用）
- INDEX: `name`（検索用）
- INDEX: `deleted_at`（論理削除されたレシピを除外する検索用）
- 複合インデックス: `(user_id, deleted_at)`（ユーザーごとの有効なレシピ検索用）

### リレーション
- `RECIPES.user_id` → `USERS.user_id` (多対1)
- `RECIPES.parent_recipe_id` → `RECIPES.recipe_id` (多対1、自己参照)
- `RECIPE_COMPONENTS.recipe_id` → `RECIPES.recipe_id` (多対1)
- `RECIPE_OUTPUTS.recipe_id` → `RECIPES.recipe_id` (多対1)
- `STOCKS.created_from_recipe_id` → `RECIPES.recipe_id` (多対1)

## 4. RECIPE_COMPONENTS（レシピの材料）

### テーブル概要
レシピのインプット（引数）を管理するテーブル。ストック管理する材料とストック管理しない材料の両方を管理。

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| component_id | UUID | PRIMARY KEY | 材料ID |
| recipe_id | UUID | NOT NULL, FOREIGN KEY | レシピID |
| product_id | UUID | FOREIGN KEY | インプットとなる製品/材料のID（ストック品の場合） |
| ingredient_name | VARCHAR(255) | | インプットの名称（ストック管理しない材料の場合） |
| input_type | VARCHAR(50) | NOT NULL | 入力方法（PRODUCT または TEXT_INPUT） |
| quantity_memo | TEXT | | 量・単位のメモ（曖昧な量も許容） |
| is_optional | BOOLEAN | NOT NULL, DEFAULT false | オプション材料か |
| required_state_transition_id | UUID | FOREIGN KEY | 要求される状態遷移ID（Phase 2以降、任意） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `component_id`
- FOREIGN KEY: `recipe_id` → `RECIPES.recipe_id`
- FOREIGN KEY: `product_id` → `PRODUCTS.id`
- FOREIGN KEY: `required_state_transition_id` → `INGREDIENT_STATE_TRANSITIONS.id`（Phase 2以降）
- INDEX: `recipe_id`（レシピごとの材料検索用）
- INDEX: `product_id`（製品ごとの使用レシピ検索用）
- INDEX: `required_state_transition_id`（Phase 2以降、状態遷移ごとの材料検索用）

### 制約
- `product_id`と`ingredient_name`は排他制約（CHECK制約）
  - `input_type = 'PRODUCT'`の場合、`product_id`はNOT NULL、`ingredient_name`はNULL
  - `input_type = 'TEXT_INPUT'`の場合、`product_id`はNULL、`ingredient_name`はNOT NULL

### リレーション
- `RECIPE_COMPONENTS.recipe_id` → `RECIPES.recipe_id` (多対1)
- `RECIPE_COMPONENTS.product_id` → `PRODUCTS.id` (多対1)
- `RECIPE_COMPONENTS.required_state_transition_id` → `INGREDIENT_STATE_TRANSITIONS.id` (多対1、Phase 2以降)

## 5. RECIPE_OUTPUTS（レシピのアウトプット）

### テーブル概要
レシピのアウトプット（戻り値）を管理するテーブル。主なアウトプットと副産物の両方を管理。

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| output_id | UUID | PRIMARY KEY | アウトプットID |
| recipe_id | UUID | NOT NULL, FOREIGN KEY | レシピID |
| product_id | UUID | NOT NULL, FOREIGN KEY | アウトプットとなる製品/材料のID（必ずPRODUCTSに登録） |
| quantity_memo | TEXT | | 量・単位のメモ（曖昧な量も許容） |
| is_main_output | BOOLEAN | NOT NULL, DEFAULT true | 主生成物か（最終料理など） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `output_id`
- FOREIGN KEY: `recipe_id` → `RECIPES.recipe_id`
- FOREIGN KEY: `product_id` → `PRODUCTS.id`
- INDEX: `recipe_id`（レシピごとのアウトプット検索用）
- INDEX: `product_id`（製品ごとの生成レシピ検索用）
- INDEX: `is_main_output`（主アウトプット検索用）

### リレーション
- `RECIPE_OUTPUTS.recipe_id` → `RECIPES.recipe_id` (多対1)
- `RECIPE_OUTPUTS.product_id` → `PRODUCTS.id` (多対1)

## 6. STOCKS（ストック）

### テーブル概要
物理的な在庫を管理するテーブル。ユーザーごとに製品ごとの在庫を管理。

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| user_id | UUID | PRIMARY KEY, FOREIGN KEY | 在庫の所有者 |
| product_id | UUID | PRIMARY KEY, FOREIGN KEY | 在庫しているPRODUCTSのID |
| status | VARCHAR(50) | NOT NULL, DEFAULT 'AVAILABLE' | 在庫の状態（AVAILABLE, NEED_REFILL, NO_REFILL） |
| quantity_memo | TEXT | | 在庫の量・単位のメモ（例: 個, パック, タッパー） |
| state_memo | TEXT | | 食材の状態メモ（Phase 1：自由入力、Phase 2以降：状態遷移から選択） |
| stocked_since_date | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | statusがAVAILABLEになった最新の日時 |
| created_from_recipe_id | UUID | FOREIGN KEY | このストックを作ったレシピのID |
| ingredient_id | UUID | FOREIGN KEY | 食材マスタID（Phase 2以降） |
| state_transition_id | UUID | FOREIGN KEY | 状態遷移ID（Phase 2以降） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `(user_id, product_id)`（複合主キー）
- FOREIGN KEY: `user_id` → `USERS.user_id`
- FOREIGN KEY: `product_id` → `PRODUCTS.id`
- FOREIGN KEY: `created_from_recipe_id` → `RECIPES.recipe_id`
- FOREIGN KEY: `ingredient_id` → `INGREDIENTS.id`（Phase 2以降）
- FOREIGN KEY: `state_transition_id` → `INGREDIENT_STATE_TRANSITIONS.id`（Phase 2以降）
- INDEX: `user_id`（ユーザーごとのストック検索用）
- INDEX: `status`（在庫状態検索用）
- INDEX: `stocked_since_date`（消費推奨アラート用）
- INDEX: `ingredient_id`（Phase 2以降、食材ごとのストック検索用）
- INDEX: `state_transition_id`（Phase 2以降、状態遷移ごとのストック検索用）

### リレーション
- `STOCKS.user_id` → `USERS.user_id` (多対1)
- `STOCKS.product_id` → `PRODUCTS.id` (多対1)
- `STOCKS.created_from_recipe_id` → `RECIPES.recipe_id` (多対1)
- `STOCKS.ingredient_id` → `INGREDIENTS.id` (多対1、Phase 2以降)
- `STOCKS.state_transition_id` → `INGREDIENT_STATE_TRANSITIONS.id` (多対1、Phase 2以降)

### 在庫状態の定義
- `AVAILABLE`: 在庫有（使用可能）
- `NEED_REFILL`: 要補充（在庫が少ない）
- `NO_REFILL`: 補充不要（使用済み、削除予定など）

## 7. INGREDIENTS（食材マスタ）- Phase 2以降

### テーブル概要
食材の基本情報を管理するテーブル。正規化の基礎となる。

**マスタデータのスコープ:**
- **基本方針**: ユーザーごとのプライベートマスタ（Phase 2初期）
- **将来の拡張**: システム共通マスタ（`is_public = true`）とユーザーカスタムマスタ（`is_public = false`）の両方をサポート
- **設計方針**: システム共通マスタをベースに、ユーザーが「カスタム状態遷移」をオーバーライドできる構造

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY | 食材ID |
| user_id | UUID | FOREIGN KEY | ユーザーID（NULLの場合はシステム共通マスタ） |
| name | VARCHAR(255) | NOT NULL | 食材名（例: 魚, 肉, 葉野菜, ひき肉） |
| category | VARCHAR(50) | | 食材カテゴリ（例: 肉類, 魚類, 野菜類） |
| is_public | BOOLEAN | NOT NULL, DEFAULT false | システム共通マスタか（`true`の場合、全ユーザーで共有） |
| standard_unit | VARCHAR(50) | | 標準単位（例: g, ml, 個）- 単位変換用（Phase 3以降） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `id`
- FOREIGN KEY: `user_id` → `USERS.user_id`
- INDEX: `name`（検索用）
- INDEX: `category`（フィルター用）
- INDEX: `user_id`（ユーザーごとの食材検索用）
- INDEX: `is_public`（システム共通マスタの検索用）
- 複合インデックス: `(user_id, is_public)`（ユーザーごとのマスタ検索用）

### リレーション
- `INGREDIENT_STATE_TRANSITIONS.ingredient_id` → `INGREDIENTS.id` (多対1)
- `STOCKS.ingredient_id` → `INGREDIENTS.id` (多対1)
- `INGREDIENTS.user_id` → `USERS.user_id` (多対1)

## 8. PROCESSES（処理マスタ）- Phase 2以降

### テーブル概要
汎用的な処理の定義を管理するテーブル。処理の再利用を可能にする。

**マスタデータのスコープ:**
- **基本方針**: ユーザーごとのプライベートマスタ（Phase 2初期）
- **将来の拡張**: システム共通マスタ（`is_public = true`）とユーザーカスタムマスタ（`is_public = false`）の両方をサポート
- **設計方針**: システム共通マスタをベースに、ユーザーが「カスタム処理」をオーバーライドできる構造

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY | 処理ID |
| user_id | UUID | FOREIGN KEY | ユーザーID（NULLの場合はシステム共通マスタ） |
| name | VARCHAR(255) | NOT NULL | 処理名（例: 焼く, 洗う, 切る, 茹でる, 炒める） |
| description | TEXT | | 処理の説明 |
| category | VARCHAR(50) | | 処理カテゴリ（加熱, 加工, 調味, 準備など） |
| parameters | JSONB | | 処理のパラメータ（Phase 2以降、道具、温度、時間、調味料など） |
| is_public | BOOLEAN | NOT NULL, DEFAULT false | システム共通マスタか（`true`の場合、全ユーザーで共有） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `id`
- FOREIGN KEY: `user_id` → `USERS.user_id`
- INDEX: `name`（検索用）
- INDEX: `category`（フィルター用）
- INDEX: `user_id`（ユーザーごとの処理検索用）
- INDEX: `is_public`（システム共通マスタの検索用）
- 複合インデックス: `(user_id, is_public)`（ユーザーごとのマスタ検索用）

### リレーション
- `INGREDIENT_STATE_TRANSITIONS.process_id` → `PROCESSES.id` (多対1)
- `PROCESSES.user_id` → `USERS.user_id` (多対1)

### 処理カテゴリの定義
- `加熱`: 焼く、煮る、炒める、蒸す、揚げる
- `加工`: 切る、削る、刻む、すりおろす
- `調味`: 塩を振る、味付けする、マリネする
- `準備`: 洗う、水に浸す、水気を切る

## 9. INGREDIENT_STATE_TRANSITIONS（状態遷移）- Phase 2以降

### テーブル概要
食材 × 処理 → 新しい状態の定義を管理するテーブル。状態遷移の正規化。

**マスタデータのスコープ:**
- **基本方針**: ユーザーごとのプライベートマスタ（Phase 2初期）
- **将来の拡張**: システム共通マスタ（`is_public = true`）とユーザーカスタムマスタ（`is_public = false`）の両方をサポート
- **設計方針**: システム共通マスタをベースに、ユーザーが「カスタム状態遷移」をオーバーライドできる構造
- **例**: システム共通で「ひき肉 + 焼く → そぼろ」が定義されている場合、ユーザーが独自の定義を追加可能

### カラム定義

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY | 状態遷移ID |
| user_id | UUID | FOREIGN KEY | ユーザーID（NULLの場合はシステム共通マスタ） |
| ingredient_id | UUID | NOT NULL, FOREIGN KEY | 食材ID |
| process_id | UUID | NOT NULL, FOREIGN KEY | 処理ID |
| output_state_name | VARCHAR(255) | NOT NULL | 出力状態名（例: 焼けた状態, 水気あり） |
| output_state_alias | VARCHAR(255) | | 出力状態の別名（例: そぼろ, 焼き魚） |
| is_public | BOOLEAN | NOT NULL, DEFAULT false | システム共通マスタか（`true`の場合、全ユーザーで共有） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | レコード更新日時 |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | レコード更新回数 |

### インデックス
- PRIMARY KEY: `id`
- FOREIGN KEY: `user_id` → `USERS.user_id`
- FOREIGN KEY: `ingredient_id` → `INGREDIENTS.id`
- FOREIGN KEY: `process_id` → `PROCESSES.id`
- INDEX: `ingredient_id`（食材ごとの状態遷移検索用）
- INDEX: `process_id`（処理ごとの状態遷移検索用）
- INDEX: `user_id`（ユーザーごとの状態遷移検索用）
- INDEX: `is_public`（システム共通マスタの検索用）
- UNIQUE: `(ingredient_id, process_id, user_id)`（同じ食材と処理の組み合わせはユーザーごとに1つまで）
- 複合インデックス: `(user_id, is_public)`（ユーザーごとのマスタ検索用）

### リレーション
- `INGREDIENT_STATE_TRANSITIONS.ingredient_id` → `INGREDIENTS.id` (多対1)
- `INGREDIENT_STATE_TRANSITIONS.process_id` → `PROCESSES.id` (多対1)
- `INGREDIENT_STATE_TRANSITIONS.user_id` → `USERS.user_id` (多対1)
- `STOCKS.state_transition_id` → `INGREDIENT_STATE_TRANSITIONS.id` (多対1)
- `RECIPE_COMPONENTS.required_state_transition_id` → `INGREDIENT_STATE_TRANSITIONS.id` (多対1)

## リレーションシップの詳細

### ユーザーとレシピ
- 1対多の関係
- ユーザーは複数のレシピを所有できる
- レシピは必ず1人のユーザーに属する

### ユーザーとストック
- 1対多の関係
- ユーザーは複数のストックを所有できる
- ストックは必ず1人のユーザーに属する

### レシピと材料（RECIPE_COMPONENTS）
- 1対多の関係
- レシピは複数の材料を持つ
- 材料は必ず1つのレシピに属する

### レシピとアウトプット（RECIPE_OUTPUTS）
- 1対多の関係
- レシピは複数のアウトプットを持つ（主なアウトプット + 副産物）
- アウトプットは必ず1つのレシピに属する

### 製品とストック
- 1対多の関係（ユーザーごと）
- 製品は複数のユーザーのストックとして存在できる
- ストックは必ず1つの製品に属する

### レシピとアレンジレシピ
- 1対多の関係（自己参照）
- 基本レシピは複数のアレンジレシピを持つ
- アレンジレシピは必ず1つの基本レシピに属する（またはNULL）

### レシピの循環参照と削除時整合性

**循環参照の防止:**
- **問題**: 「カレー = ポトフ（レシピA） + カレー粉」という依存関係がある場合、レシピAを削除しようとした時の挙動が未定義
- **対策**: 
	- **論理削除を基本とする**: `deleted_at`カラムを使用し、物理削除は行わない
	- **依存関係のチェック**: レシピ削除時に、他のレシピから参照されている場合は削除を制限（エラーメッセージを表示）
	- **循環参照の検出**: レシピの依存関係をグラフ構造として管理し、循環参照（DAG違反）を検出するロジックを実装

**削除時の整合性:**
- **論理削除**: `deleted_at`カラムに日時を設定（物理削除は行わない）
- **依存関係の確認**: レシピ削除前に、以下をチェック
	- 他のレシピの材料（RECIPE_COMPONENTS）として参照されているか
	- アレンジレシピの親レシピ（parent_recipe_id）として参照されているか
	- ストックの作成元（created_from_recipe_id）として参照されているか
- **削除制限**: 依存関係がある場合は削除を制限し、エラーメッセージを表示
- **削除オプション**: 依存関係がある場合でも削除したい場合は、依存関係を先に解除する必要がある

**実装方針:**
- Phase 1: 論理削除（`deleted_at`）を実装、依存関係のチェックは簡易的に実装
- Phase 2以降: 依存グラフの可視化と循環参照検出機能を追加

## マイグレーション戦略

### Phase 1
- 全テーブルの基本構造を実装
- アレンジレシピの`parent_recipe_id`はPhase 1で実装するが、機能はPhase 1.5で実装
- STOCKSテーブルに`state_memo`カラムを追加（自由入力、TEXT型）

### Phase 1.5
- アレンジレシピ機能の実装（データモデルは既に対応済み）

### Phase 2以降
- 食材の状態遷移の本格的な管理（正規化）
	- INGREDIENTSテーブルの追加
	- PROCESSESテーブルの追加
	- INGREDIENT_STATE_TRANSITIONSテーブルの追加
	- STOCKSテーブルに`ingredient_id`と`state_transition_id`カラムを追加
	- RECIPE_COMPONENTSテーブルに`required_state_transition_id`カラムを追加
- 既存データとの互換性を保つ
	- Phase 1の`state_memo`データは、Phase 2以降も参照可能（移行期間中）

## 拡張性の考慮

### JSONカラムの活用（将来の拡張）
- PROCESSESテーブルの`parameters (JSONB)`で、処理のパラメータ（道具、温度、時間、調味料など）を柔軟に管理
- 将来の拡張に対応できるよう設計

### 外部キー制約
- 必須の外部キーは制約を設定
- オプションの外部キー（`parent_recipe_id`、`created_from_recipe_id`、`ingredient_id`、`state_transition_id`、`required_state_transition_id`）はNULLを許可

### インデックス戦略
- 検索頻度の高いカラムにインデックスを設定
- 複合インデックスも必要に応じて追加
- INGREDIENT_STATE_TRANSITIONSテーブルに`(ingredient_id, process_id)`のUNIQUE制約を設定

### 処理の抽象化・共通化の難しさへの対応
- Phase 1：処理はシンプルな名前で管理（道具や詳細は手順に記載）
- Phase 2以降：処理のカテゴリやパラメータを段階的に追加（使ってみて必要になったら追加）
- 完璧な正規化を目指すのではなく、実用性とのバランスを重視



