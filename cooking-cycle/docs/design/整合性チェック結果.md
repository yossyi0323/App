# 整合性チェック結果

要件定義と設計ドキュメントの整合性を確認した結果です。

## 重大な不整合

### 1. ストックとレシピの紐づけ方法の不一致

**問題点：**
- **機能一覧（01. 機能一覧.md）**: 「どのレシピの材料になるか（Optional、複数可）」という入力項目があり、処理で「used_in_recipe_ids」でレシピとの紐づけをすると記載
- **テーブル定義書（04. テーブル定義書.md）**: STOCKSテーブルに`used_in_recipe_ids`カラムが存在しない
- **要件定義書（01. 機能要件定義書.md）**: Phase 1の実装方針として「`used_in_recipe_ids (JSON, どのレシピの材料になるか)`」が挙げられている
- **概念データモデル（02. 概念データモデル（ER図）.md）**: STOCKSテーブルに`used_in_recipe_ids`カラムは含まれていない

**実際の設計：**
- RECIPE_COMPONENTSテーブルの`product_id`から逆引きする設計になっている
- ストック詳細表示機能（2.5）では「RECIPE_COMPONENTSテーブルから、このストック（PRODUCTS）を使うレシピを検索」と記載されている

**解決策：**
- 機能一覧の処理内容を修正し、`used_in_recipe_ids`ではなく、RECIPE_COMPONENTSテーブルから逆引きする設計であることを明記
- または、要件定義書のPhase 1の実装方針を、概念データモデルに合わせて修正

### 2. Phase 1の実装方針とテーブル定義の不一致

**問題点：**
- **要件定義書（01. 機能要件定義書.md）Phase 1の実装方針**:
  - レシピテーブル：`ingredients (JSON)`, `steps (JSON)`
  - ストックテーブル：`used_in_recipe_ids (JSON)`
- **テーブル定義書（04. テーブル定義書.md）**:
  - RECIPE_COMPONENTSテーブル（正規化された構造）
  - RECIPE_OUTPUTSテーブル
  - STOCKSテーブルに`used_in_recipe_ids`なし

**解決策：**
- 要件定義書のPhase 1の実装方針を、概念データモデル（正規化された構造）に合わせて修正
- または、Phase 1ではJSONカラムを使い、Phase 2で正規化する方針を明確化

### 3. ストックの種類の用語統一

**問題点：**
- **機能一覧・画面設計書**: 「完成品/中間成果物/食材」という日本語表記
- **テーブル定義書**: `raw_material`, `intermediate`, `final_dish`という英語表記
- **API設計書**: `final_dish`, `intermediate`, `raw_material`という英語表記

**解決策：**
- 用語を統一する（推奨：テーブル定義書の英語表記に統一し、画面表示時に日本語に変換）

## 中程度の不整合

### 4. 場所メモのPhase

**現状：**
- **機能一覧・画面設計書**: Phase 2以降
- **要件定義書（08. 開発フェーズ・実装計画.md）**: Phase 2の機能として記載
- **initial-idea.md**: Must-Have機能として挙げられている可能性

**確認事項：**
- initial-idea.mdのMust-Have機能との整合性を確認
- Phase 2で問題ないか確認

### 5. ストック登録時の製品作成方法

**問題点：**
- **機能一覧（2.1 ストック登録）**: 「PRODUCTSテーブルから該当製品を取得または作成」と記載
- **API設計書（POST /api/stocks）**: `product_id`または`product_name`のどちらを送るか不明確

**解決策：**
- API設計書で、`product_id`が指定されていない場合は`product_name`から製品を自動作成する仕様を明記

### 6. ストック詳細表示の実装方法

**問題点：**
- **機能一覧（2.5 ストック詳細表示）**: 「このストックを使うレシピ一覧の取得（このストックが材料になるレシピ）」
- **API設計書（GET /api/stocks/[id]）**: `used_in_recipes`がレスポンスに含まれている
- **テーブル定義書**: STOCKSテーブルに`used_in_recipe_ids`カラムがない

**解決策：**
- API設計書のレスポンス仕様を、RECIPE_COMPONENTSテーブルから逆引きする実装であることを明記

## 軽微な不整合・不足

### 7. USERSテーブルの定義

**現状：**
- **概念データモデル（ER図）**: USERSテーブルが含まれているが、詳細定義がない
- **テーブル定義書**: USERSテーブルが定義されている

**確認事項：**
- 概念データモデルのER図にUSERSテーブルの詳細を追加するか検討

### 8. アレンジレシピの手順継承方法

**問題点：**
- **要件定義書**: 「手順の継承方法：基本レシピの手順を継承するのか、完全に別にするのか」が検討事項として挙げられている
- **機能一覧（1.6 アレンジレシピ登録）**: 「手順の変更（任意）」と記載されているが、継承方法の詳細が不明確

**解決策：**
- アレンジレシピの手順継承方法を明確化（基本レシピの手順をデフォルトで表示し、変更がある場合のみ上書きする、など）

### 9. ストック消費処理の実装

**問題点：**
- **機能一覧（2.6 ストック消費処理）**: 「消費方法（削除/量を減らす、必須）」と記載
- **機能一覧の処理内容**: 「Phase 1では削除のみ実装」と記載
- **API設計書**: ストック消費処理のAPIエンドポイントが定義されていない

**解決策：**
- API設計書にストック消費処理のエンドポイントを追加（DELETE /api/stocks/[id]で実現するのか、専用エンドポイントが必要か）

### 10. ストック優先フィルターの実装詳細

**問題点：**
- **機能一覧（3.1 ストック優先フィルター）**: ストックの種類に応じたフィルターロジックが記載されている
- **API設計書（GET /api/recipes/filter-by-stock）**: 実装詳細が不明確

**解決策：**
- API設計書に、完成品・中間成果物・食材それぞれのフィルターロジックの詳細を追加

## 状態遷移関連の追加（2025-01-XX更新）

### 11. 食材の状態遷移の実装方針

**現状：**
- **要件定義書**: 食材の状態遷移の概念が追加され、Phase 1で`state_memo`（自由入力）、Phase 2以降で正規化された構造（INGREDIENTS、PROCESSES、INGREDIENT_STATE_TRANSITIONS）が定義されている
- **テーブル定義書**: Phase 2以降のテーブル（INGREDIENTS、PROCESSES、INGREDIENT_STATE_TRANSITIONS）が追加されている
- **機能一覧**: Phase 2以降の食材の状態遷移管理機能が追加されている
- **API設計書**: Phase 2以降の食材マスタ、処理マスタ、状態遷移APIが追加されている

**確認事項：**
- 要件定義書と設計ドキュメントの整合性は取れている
- Phase 1とPhase 2以降の実装方針が明確に分離されている

## Geminiレビューによる追加指摘事項（2025-01-XX更新）

### 12. マスタデータのスコープ（共有か個人か）

**問題点：**
- **テーブル定義書**: PRODUCTS、INGREDIENTS、PROCESSES、INGREDIENT_STATE_TRANSITIONSがシステム全体の共有マスタなのか、ユーザーごとのプライベートマスタなのかが曖昧
- **懸念**: 共有マスタの場合、一人のユーザーが定義を書き換えると他のユーザーに影響。個人用だと、マスタの登録負荷がユーザーにかかる

**解決策（反映済み）：**
- **テーブル定義書**: マスタデータのスコープを明確化
	- Phase 1: PRODUCTSはユーザーごとのプライベートマスタ
	- Phase 2以降: INGREDIENTS、PROCESSES、INGREDIENT_STATE_TRANSITIONSに`user_id`と`is_public`フラグを追加
	- システム共通マスタ（`is_public = true`）をベースに、ユーザーが「カスタム状態遷移」をオーバーライドできる構造

### 13. Phase 1とPhase 2のバリデーションの乖離

**問題点：**
- **API設計書**: Phase 2のバリデーションが既に記載されているが、Phase 1の実装コード内でPhase 2用のカラムを「必須」としてバリデーションしてしまうと、Phase 1のフロントエンドからデータが送られずエラーになる

**解決策（反映済み）：**
- **API設計書**: Phase別のバリデーション戦略を追加
	- Phase 1: Phase 2用のカラム（`ingredient_id`、`state_transition_id`、`required_state_transition_id`）は**任意**として扱う
	- Phase 2: Phase 2用のカラムのバリデーションを有効化
	- バリデーションロジックは環境変数や設定ファイルで制御可能にする

### 14. レシピの循環参照と削除時整合性

**問題点：**
- **リスク**: 「カレー = ポトフ（レシピA） + カレー粉」という依存関係がある場合、レシピAを削除しようとした時の挙動が未定義
- **懸念**: `ON DELETE CASCADE`で連鎖削除されると、ユーザーの意図しないデータ消失が起きる

**解決策（反映済み）：**
- **テーブル定義書**: レシピの循環参照と削除時整合性のセクションを追加
	- 論理削除（`deleted_at`）を基本とする
	- 依存関係のチェックロジックを実装
	- 循環参照（DAG違反）の検出機能を追加

### 15. Next.js App RouterとREST APIの使い分け

**問題点：**
- **リスク**: API設計書はRESTfulだが、Next.js App RouterではServer Actionsを使うことでAPIエンドポイントを意識せずにDB操作が可能

**解決策（反映済み）：**
- **API設計書**: Next.js App RouterとREST APIの使い分けのセクションを追加
	- Phase 1: REST APIエンドポイント（`/api/*`）を使用（PWAとしてオフライン動作や外部連携を強く意識）
	- Phase 2以降: 開発効率を優先する場合はServer Actionsへの集約も検討可能

### 16. 単位変換レイヤー

**問題点：**
- **必要性**: プログラマブルに扱う際、インプットの「大さじ1」と「15ml」、あるいは「玉ねぎ1個」と「200g」をどう計算（キャスト）するかが課題

**解決策（反映済み）：**
- **要件定義書**: Phase 3以降の機能として追加
	- INGREDIENTSテーブルに`standard_unit`（標準単位）を追加
	- 容積・重量の変換係数を持たせる「単位変換メソッド」の概念を導入

### 17. レシピの依存グラフの可視化

**問題点：**
- **必要性**: 複雑なレシピチェーンを組むと、何が何に依存しているか把握しづらくなる

**解決策（反映済み）：**
- **要件定義書**: Phase 3以降の機能として追加
	- レシピの依存関係をグラフ構造（DAG: Directed Acyclic Graph）として管理
	- 依存グラフを視覚化するUI
	- 循環参照（無限ループ）の検出機能

### 18. 状態遷移の論理テストケース

**問題点：**
- **不足分**: 単体テスト仕様書にはCRUDテストはあるが、「`RawMeat` + `Frying` = `CookedMeat`」という状態遷移マスタが期待通りに計算されるかのロジックテストが不足

**解決策（反映済み）：**
- **単体テスト仕様書**: Phase 2以降のテスト対象機能として追加
	- 状態遷移の計算テスト
	- 状態遷移の検証テスト
	- 循環参照検出テスト

### 19. 在庫の整合性テスト

**問題点：**
- **不足分**: 「レシピを実行した際、材料となったストックの数量が正しく減算され、アウトプットのストックが生成されるか」という、一連のトランザクションテストが統合テスト（E2E）に必要

**解決策（反映済み）：**
- **統合テスト仕様書**: Phase 2以降のE2Eテストシナリオとして追加
	- レシピ実行時の在庫消費と生成のテスト
	- 在庫不足時のエラーハンドリングテスト
	- トランザクションの整合性テスト

## 推奨される修正

### 優先度：高

1. **機能一覧の修正**: `used_in_recipe_ids`の記述を削除し、RECIPE_COMPONENTSテーブルから逆引きする設計であることを明記
2. **要件定義書のPhase 1実装方針の修正**: 概念データモデル（正規化された構造）に合わせて修正
3. **API設計書の修正**: ストック登録時の製品作成方法、ストック詳細表示の実装方法を明確化

### 優先度：中

4. **用語の統一**: ストックの種類の表記を統一（英語表記に統一し、画面表示時に日本語に変換）
5. **API設計書の追加**: ストック消費処理のエンドポイントを追加
6. **機能一覧の明確化**: アレンジレシピの手順継承方法を明確化

### 優先度：低

7. **概念データモデルの補完**: USERSテーブルの詳細定義を追加（オプション）
8. **場所メモのPhase確認**: initial-idea.mdとの整合性を確認
9. **状態遷移の実装詳細**: Phase 2以降の実装時に、処理の抽象化・共通化の難しさを考慮した実装方針を明確化



