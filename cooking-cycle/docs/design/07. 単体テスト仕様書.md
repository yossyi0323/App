# 単体テスト仕様書

## 概要

単体テストの対象機能、テストケース、テストデータ設計を定義します。

## テスト環境

- **テストフレームワーク:** Vitest
- **テストランナー:** Vitest
- **カバレッジツール:** Vitest（c8）

## テスト対象機能

### 1. レシピ管理機能

#### 1.1 基本レシピ登録
**テスト対象:** `app/api/recipes/route.ts` (POST)

**テストケース:**
1. **正常系: レシピ登録成功**
   - 入力: 有効なレシピ情報
   - 期待結果: レシピIDが返される、レシピがDBに保存される

2. **異常系: バリデーションエラー（レシピ名が空）**
   - 入力: レシピ名が空
   - 期待結果: 400エラー、エラーメッセージが返される

3. **異常系: バリデーションエラー（材料が空）**
   - 入力: 材料が空
   - 期待結果: 400エラー、エラーメッセージが返される

4. **異常系: バリデーションエラー（手順が空）**
   - 入力: 手順が空
   - 期待結果: 400エラー、エラーメッセージが返される

5. **異常系: 認証エラー**
   - 入力: 認証されていないリクエスト
   - 期待結果: 401エラー

#### 1.2 基本レシピ編集
**テスト対象:** `app/api/recipes/[id]/route.ts` (PUT)

**テストケース:**
1. **正常系: レシピ更新成功**
   - 入力: 有効なレシピ情報
   - 期待結果: レシピが更新される

2. **異常系: レシピが見つからない**
   - 入力: 存在しないレシピID
   - 期待結果: 404エラー

3. **異常系: 所有権エラー**
   - 入力: 他のユーザーのレシピID
   - 期待結果: 403エラー

#### 1.3 基本レシピ削除
**テスト対象:** `app/api/recipes/[id]/route.ts` (DELETE)

**テストケース:**
1. **正常系: レシピ削除成功**
   - 入力: 有効なレシピID
   - 期待結果: レシピが削除される、関連レコードも削除される

2. **異常系: レシピが見つからない**
   - 入力: 存在しないレシピID
   - 期待結果: 404エラー

3. **異常系: 所有権エラー**
   - 入力: 他のユーザーのレシピID
   - 期待結果: 403エラー

#### 1.4 レシピ一覧表示
**テスト対象:** `app/api/recipes/route.ts` (GET)

**テストケース:**
1. **正常系: レシピ一覧取得成功**
   - 入力: 有効なユーザーID
   - 期待結果: レシピ一覧が返される

2. **正常系: ページネーション**
   - 入力: page=2, limit=10
   - 期待結果: 2ページ目のレシピ一覧が返される

3. **正常系: ソート**
   - 入力: sort=created_at, order=desc
   - 期待結果: 作成日時の降順でソートされたレシピ一覧が返される

#### 1.5 レシピ詳細表示
**テスト対象:** `app/api/recipes/[id]/route.ts` (GET)

**テストケース:**
1. **正常系: レシピ詳細取得成功**
   - 入力: 有効なレシピID
   - 期待結果: レシピ詳細情報が返される、材料情報、アウトプット情報、在庫有無が含まれる

2. **正常系: アレンジレシピ一覧**
   - 入力: 基本レシピID
   - 期待結果: アレンジレシピ一覧が含まれる

3. **異常系: レシピが見つからない**
   - 入力: 存在しないレシピID
   - 期待結果: 404エラー

### 2. ストック管理機能

#### 2.1 ストック登録
**テスト対象:** `app/api/stocks/route.ts` (POST)

**テストケース:**
1. **正常系: ストック登録成功**
   - 入力: 有効なストック情報
   - 期待結果: ストックIDが返される、ストックがDBに保存される

2. **正常系: 製品の自動作成**
   - 入力: 存在しない製品名
   - 期待結果: 製品が自動作成される、ストックが登録される

3. **異常系: バリデーションエラー（製品名が空）**
   - 入力: 製品名が空
   - 期待結果: 400エラー

4. **異常系: バリデーションエラー（製品タイプが無効）**
   - 入力: 無効な製品タイプ
   - 期待結果: 400エラー

#### 2.2 ストック編集
**テスト対象:** `app/api/stocks/[id]/route.ts` (PUT)

**テストケース:**
1. **正常系: ストック更新成功**
   - 入力: 有効なストック情報
   - 期待結果: ストックが更新される

2. **異常系: ストックが見つからない**
   - 入力: 存在しないストックID
   - 期待結果: 404エラー

3. **異常系: 所有権エラー**
   - 入力: 他のユーザーのストックID
   - 期待結果: 403エラー

#### 2.3 ストック削除
**テスト対象:** `app/api/stocks/[id]/route.ts` (DELETE)

**テストケース:**
1. **正常系: ストック削除成功**
   - 入力: 有効なストックID
   - 期待結果: ストックが削除される

2. **異常系: ストックが見つからない**
   - 入力: 存在しないストックID
   - 期待結果: 404エラー

#### 2.4 ストック一覧表示
**テスト対象:** `app/api/stocks/route.ts` (GET)

**テストケース:**
1. **正常系: ストック一覧取得成功**
   - 入力: 有効なユーザーID
   - 期待結果: ストック一覧が返される

2. **正常系: 消費推奨アラート**
   - 入力: 1ヶ月以上経過したストック
   - 期待結果: `needs_alert: true`が返される

3. **正常系: フィルター（種類）**
   - 入力: type=final_dish
   - 期待結果: 完成品のみが返される

#### 2.5 ストック詳細表示
**テスト対象:** `app/api/stocks/[id]/route.ts` (GET)

**テストケース:**
1. **正常系: ストック詳細取得成功**
   - 入力: 有効なストックID
   - 期待結果: ストック詳細情報が返される、使用レシピ一覧が含まれる

2. **異常系: ストックが見つからない**
   - 入力: 存在しないストックID
   - 期待結果: 404エラー

### 3. 検索・フィルター機能

#### 3.1 ストック優先フィルター
**テスト対象:** `app/api/recipes/filter-by-stock/route.ts` (GET)

**テストケース:**
1. **正常系: 完成品のフィルター**
   - 入力: 完成品ストックが存在
   - 期待結果: その完成品をアウトプットに持つレシピが返される

2. **正常系: 中間成果物のフィルター**
   - 入力: 中間成果物ストックが存在
   - 期待結果: その中間成果物を材料に持つレシピが返される

3. **正常系: 食材のフィルター**
   - 入力: 食材ストックが存在
   - 期待結果: その食材を材料に持つレシピが返される

4. **正常系: 複数ストックのフィルター**
   - 入力: 複数のストックが存在
   - 期待結果: すべてのストックに対応するレシピが返される

#### 3.2 キーワード検索
**テスト対象:** `app/api/recipes/search/route.ts` (GET)

**テストケース:**
1. **正常系: レシピ名での検索**
   - 入力: keyword=ペペロンチーノ
   - 期待結果: レシピ名に「ペペロンチーノ」を含むレシピが返される

2. **正常系: 材料名での検索**
   - 入力: keyword=にんにく
   - 期待結果: 材料に「にんにく」を含むレシピが返される

3. **正常系: 部分一致検索**
   - 入力: keyword=ペペ
   - 期待結果: 「ペペロンチーノ」などが返される

4. **正常系: 検索結果なし**
   - 入力: keyword=存在しないキーワード
   - 期待結果: 空の配列が返される

### 4. 認証機能

#### 4.1 Google認証
**テスト対象:** `app/api/auth/google/route.ts` (GET)

**テストケース:**
1. **正常系: 認証リダイレクト**
   - 入力: 認証リクエスト
   - 期待結果: Google認証ページにリダイレクト

#### 4.2 ログアウト
**テスト対象:** `app/api/auth/logout/route.ts` (POST)

**テストケース:**
1. **正常系: ログアウト成功**
   - 入力: 認証されたリクエスト
   - 期待結果: セッションが無効化される

### 5. 状態遷移管理機能（Phase 2以降）

#### 5.1 状態遷移の適用ロジック
**テスト対象:** 状態遷移適用処理（ストック登録・更新時の内部処理）

**テストケース:**
1. **正常系: 状態遷移の適用**
   - 入力: 生の状態の食材ストック（`ingredient_id: ひき肉`, `state_transition_id: null`）に「焼く」処理を適用
   - 期待結果: 新しいストックが生成され、`state_transition_id`が「焼く」処理の状態遷移IDに設定される
   - 期待結果: 元のストック（生の状態）が消費される、または量が減る

2. **正常系: 状態遷移後のストック生成**
   - 入力: 食材ID「ひき肉」、処理ID「焼く」、状態遷移ID「ひき肉×焼く→そぼろ」
   - 期待結果: 新しいストックが生成され、`ingredient_id`が「ひき肉」、`state_transition_id`が「ひき肉×焼く→そぼろ」のIDに設定される

3. **正常系: 状態遷移の別名（alias）の適用**
   - 入力: 状態遷移に別名「そぼろ」が設定されている場合
   - 期待結果: 生成されたストックの表示名が「そぼろ」として扱われる

4. **異常系: 存在しない状態遷移の適用**
   - 入力: 存在しない`state_transition_id`
   - 期待結果: 400エラー、エラーメッセージが返される

5. **異常系: 食材と処理の組み合わせが不正**
   - 入力: 食材ID「ひき肉」、処理ID「洗う」（不適切な組み合わせ）
   - 期待結果: 400エラー、エラーメッセージが返される

#### 5.2 レシピと状態のマッチングロジック
**テスト対象:** ストック優先フィルター処理内の状態マッチングロジック

**テストケース:**
1. **正常系: 状態指定なしのレシピ（任意の状態でマッチ）**
   - 入力: レシピの材料に`required_state_transition_id`がNULL
   - 入力: ストックの状態が任意（`state_transition_id`がNULLでも可）
   - 期待結果: マッチする

2. **正常系: 状態指定ありのレシピ（一致する状態でマッチ）**
   - 入力: レシピの材料に`required_state_transition_id`が「ひき肉×焼く→そぼろ」を指定
   - 入力: ストックの`state_transition_id`が「ひき肉×焼く→そぼろ」と一致
   - 期待結果: マッチする

3. **異常系: 状態指定ありのレシピ（不一致の状態でマッチしない）**
   - 入力: レシピの材料に`required_state_transition_id`が「ひき肉×焼く→そぼろ」を指定
   - 入力: ストックの`state_transition_id`が「ひき肉×生→生のまま」と不一致
   - 期待結果: マッチしない

#### 5.3 食材マスタ管理
**テスト対象:** `app/api/ingredients/route.ts` (POST, GET)

**テストケース:**
1. **正常系: 食材登録成功**
   - 入力: 有効な食材情報
   - 期待結果: 食材IDが返される、食材がDBに保存される

2. **異常系: バリデーションエラー（食材名が空）**
   - 入力: 食材名が空
   - 期待結果: 400エラー

#### 5.4 処理マスタ管理
**テスト対象:** `app/api/processes/route.ts` (POST, GET)

**テストケース:**
1. **正常系: 処理登録成功**
   - 入力: 有効な処理情報（処理名、カテゴリ、パラメータ）
   - 期待結果: 処理IDが返される、処理がDBに保存される

2. **正常系: 処理のパラメータ（JSONB）の保存**
   - 入力: 処理のパラメータ（`{"tool": "フライパン", "temperature": "中火", "time": "5分"}`）
   - 期待結果: パラメータが正しくJSONB形式で保存される

#### 5.5 状態遷移マスタ管理
**テスト対象:** `app/api/ingredient-state-transitions/route.ts` (POST, GET)

**テストケース:**
1. **正常系: 状態遷移登録成功**
   - 入力: 有効な状態遷移情報（食材ID、処理ID、出力状態名）
   - 期待結果: 状態遷移IDが返される、状態遷移がDBに保存される

2. **正常系: 状態遷移の別名（alias）の登録**
   - 入力: 出力状態名「ひき肉（焼けた状態）」、別名「そぼろ」
   - 期待結果: 別名が正しく保存される

3. **異常系: 同じ食材と処理の組み合わせの重複**
   - 入力: 既に存在する食材IDと処理IDの組み合わせ
   - 期待結果: 400エラー（UNIQUE制約違反）

## テストデータ設計

### テストユーザー
```typescript
const testUser = {
  user_id: "test-user-id",
  email: "test@example.com",
  name: "テストユーザー"
};
```

### テストレシピ
```typescript
const testRecipe = {
  recipe_id: "test-recipe-id",
  user_id: "test-user-id",
  name: "テストレシピ",
  recipe_url: "https://youtube.com/watch?v=test",
  instructions_text: "手順1\n手順2",
  components: [
    {
      product_id: "test-product-id",
      input_type: "PRODUCT",
      quantity_memo: "2食分",
      is_optional: false
    }
  ],
  outputs: [
    {
      product_id: "test-product-id",
      quantity_memo: "2食分",
      is_main_output: true
    }
  ]
};
```

### テストストック
```typescript
const testStock = {
  user_id: "test-user-id",
  product_id: "test-product-id",
  status: "AVAILABLE",
  quantity_memo: "2食分",
  stocked_since_date: new Date("2025-01-01")
};
```

### テスト製品
```typescript
const testProduct = {
  id: "test-product-id",
  name: "テスト製品",
  type: "final_dish",
  is_stockable: true
};
```

## カバレッジ目標

- **全体カバレッジ:** 80%以上
- **APIエンドポイント:** 100%
- **ビジネスロジック:** 90%以上
- **ユーティリティ関数:** 80%以上

## Vitestのテスト構造

### ディレクトリ構成

```
__tests__/
  api/
    recipes/
      create.test.ts
      update.test.ts
      delete.test.ts
      list.test.ts
      detail.test.ts
    stocks/
      create.test.ts
      update.test.ts
      delete.test.ts
      list.test.ts
      detail.test.ts
    search/
      filter-by-stock.test.ts
      keyword.test.ts
  utils/
    validation.test.ts
    format.test.ts
  lib/
    db.test.ts
```

### テストファイルの例

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { POST } from '@/app/api/recipes/route';

describe('レシピ登録API', () => {
  beforeEach(() => {
    // テストデータのセットアップ
  });

  afterEach(() => {
    // テストデータのクリーンアップ
  });

  it('正常系: レシピ登録成功', async () => {
    const request = new Request('http://localhost:3000/api/recipes', {
      method: 'POST',
      body: JSON.stringify(testRecipe),
      headers: { 'Content-Type': 'application/json' }
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(200);
    expect(data.recipe_id).toBeDefined();
  });

  it('異常系: バリデーションエラー（レシピ名が空）', async () => {
    const invalidRecipe = { ...testRecipe, name: '' };
    const request = new Request('http://localhost:3000/api/recipes', {
      method: 'POST',
      body: JSON.stringify(invalidRecipe),
      headers: { 'Content-Type': 'application/json' }
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(400);
    expect(data.error.code).toBe('VALIDATION_ERROR');
  });
});
```

## Phase 2以降のテスト対象機能

### 食材の状態遷移管理機能（Phase 2以降）

#### 状態遷移の論理テスト

**テスト対象:** `lib/state-transition.ts`（状態遷移のロジック）

**テストケース:**
1. **正常系: 状態遷移の計算**
   - 入力: `ingredient_id = "ひき肉"`, `process_id = "焼く"`
   - 期待結果: `output_state_name = "焼けた状態"`, `output_state_alias = "そぼろ"`

2. **正常系: 状態遷移の検証**
   - 入力: `RawMeat` + `Frying` = `CookedMeat`
   - 期待結果: 状態遷移マスタが期待通りに計算される

3. **異常系: 存在しない食材と処理の組み合わせ**
   - 入力: 存在しない`ingredient_id`と`process_id`の組み合わせ
   - 期待結果: エラーまたはNULLを返す

4. **異常系: 同じ食材と処理の組み合わせの重複**
   - 入力: 既に存在する`ingredient_id`と`process_id`の組み合わせ
   - 期待結果: UNIQUE制約違反エラー

#### レシピの循環参照検出テスト

**テスト対象:** `lib/recipe-dependency.ts`（レシピの依存関係チェック）

**テストケース:**
1. **正常系: 循環参照なし**
   - 入力: 正常なレシピの依存関係
   - 期待結果: 循環参照なし、依存グラフが正常に構築される

2. **異常系: 循環参照の検出**
   - 入力: レシピAがレシピBに依存し、レシピBがレシピAに依存する
   - 期待結果: 循環参照エラーを検出

3. **正常系: 依存関係の可視化**
   - 入力: レシピID
   - 期待結果: 依存グラフ（DAG）が正しく構築される

#### 在庫の整合性テスト

**テスト対象:** `lib/stock-consumption.ts`（在庫消費のロジック）

**テストケース:**
1. **正常系: レシピ実行時の在庫消費**
   - 入力: レシピID、人数分
   - 期待結果: 
     - 材料となったストックの数量が正しく減算される
     - アウトプットのストックが生成される
     - トランザクションが正常に完了する

2. **異常系: 在庫不足**
   - 入力: 在庫が不足している材料を含むレシピ
   - 期待結果: 在庫不足エラー、トランザクションがロールバックされる

3. **正常系: 部分的な在庫消費**
   - 入力: 2食分のストックから1食分を消費
   - 期待結果: ストックの数量が正しく更新される（削除ではなく更新）

## テスト実行

### コマンド

```bash
# すべてのテストを実行
npm test

# ウォッチモード
npm test:watch

# カバレッジレポート
npm test:coverage
```

### CI/CD統合

- GitHub Actionsで自動実行
- プルリクエスト時にテストを実行
- カバレッジレポートを生成



