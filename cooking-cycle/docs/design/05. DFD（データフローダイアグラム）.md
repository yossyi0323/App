# DFD（データフローダイアグラム）

## 概要

システム全体のデータフローを可視化したダイアグラムです。

## 記号の説明

- **プロセス（円）**: データを処理する機能
- **データストア（二重線）**: データを保存する場所
- **外部エンティティ（四角）**: システム外部の存在
- **データフロー（矢印）**: データの流れ

## レベル0 DFD（コンテキスト図）

```mermaid
flowchart LR
    User[ユーザー] -->|レシピ・ストック情報| System[料理サイクルシステム]
    System -->|レシピ・ストック情報| User
    Google[Google認証] -->|認証情報| System
    System -->|認証リクエスト| Google
    YouTube[YouTube] -->|動画URL| System
    System -->|動画リンク| YouTube
```

## レベル1 DFD（トップレベル）

```mermaid
flowchart TD
    User[ユーザー] -->|レシピ登録| P1[レシピ管理プロセス]
    User -->|ストック登録| P2[ストック管理プロセス]
    User -->|検索・フィルター| P3[検索・フィルタープロセス]
    User -->|認証リクエスト| P4[認証プロセス]
    
    P1 -->|レシピ情報| D1[(レシピDB)]
    P1 -->|材料情報| D2[(材料DB)]
    P1 -->|アウトプット情報| D3[(アウトプットDB)]
    P1 -->|製品情報| D4[(製品DB)]
    
    P2 -->|ストック情報| D5[(ストックDB)]
    P2 -->|製品情報| D4
    P2 -->|レシピ情報| D1
    
    P3 -->|検索条件| D1
    P3 -->|検索条件| D5
    P3 -->|検索結果| User
    
    P4 -->|認証情報| D6[(ユーザーDB)]
    P4 -->|認証リクエスト| Google[Google認証]
    Google -->|認証結果| P4
    
    D1 -->|レシピ情報| P1
    D2 -->|材料情報| P1
    D3 -->|アウトプット情報| P1
    D4 -->|製品情報| P1
    D5 -->|ストック情報| P2
    D6 -->|ユーザー情報| P4
```

## レベル2 DFD（詳細レベル）

### レシピ管理プロセス

```mermaid
flowchart TD
    User[ユーザー] -->|レシピ登録リクエスト| P1_1[レシピ登録処理]
    User -->|レシピ編集リクエスト| P1_2[レシピ編集処理]
    User -->|レシピ削除リクエスト| P1_3[レシピ削除処理]
    User -->|レシピ一覧取得リクエスト| P1_4[レシピ一覧取得処理]
    User -->|レシピ詳細取得リクエスト| P1_5[レシピ詳細取得処理]
    
    P1_1 -->|レシピ情報| D1[(レシピDB)]
    P1_1 -->|材料情報| D2[(材料DB)]
    P1_1 -->|アウトプット情報| D3[(アウトプットDB)]
    P1_1 -->|製品情報| D4[(製品DB)]
    
    P1_2 -->|レシピ情報| D1
    P1_2 -->|材料情報| D2
    P1_2 -->|アウトプット情報| D3
    
    P1_3 -->|削除リクエスト| D1
    P1_3 -->|削除リクエスト| D2
    P1_3 -->|削除リクエスト| D3
    
    P1_4 -->|検索条件| D1
    D1 -->|レシピ一覧| P1_4
    P1_4 -->|レシピ一覧| User
    
    P1_5 -->|レシピID| D1
    P1_5 -->|レシピID| D2
    P1_5 -->|レシピID| D3
    P1_5 -->|レシピID| D5[(ストックDB)]
    D1 -->|レシピ情報| P1_5
    D2 -->|材料情報| P1_5
    D3 -->|アウトプット情報| P1_5
    D5 -->|在庫情報| P1_5
    P1_5 -->|レシピ詳細| User
```

### ストック管理プロセス

```mermaid
flowchart TD
    User[ユーザー] -->|ストック登録リクエスト| P2_1[ストック登録処理]
    User -->|ストック編集リクエスト| P2_2[ストック編集処理]
    User -->|ストック削除リクエスト| P2_3[ストック削除処理]
    User -->|ストック一覧取得リクエスト| P2_4[ストック一覧取得処理]
    User -->|ストック詳細取得リクエスト| P2_5[ストック詳細取得処理]
    
    P2_1 -->|製品情報| D4[(製品DB)]
    P2_1 -->|ストック情報| D5[(ストックDB)]
    P2_1 -->|レシピ情報| D1[(レシピDB)]
    
    P2_2 -->|ストック情報| D5
    
    P2_3 -->|削除リクエスト| D5
    
    P2_4 -->|検索条件| D5
    D5 -->|ストック一覧| P2_4
    P2_4 -->|ストック一覧| User
    
    P2_5 -->|ストックID| D5
    P2_5 -->|製品ID| D4
    P2_5 -->|製品ID| D2[(材料DB)]
    D5 -->|ストック情報| P2_5
    D4 -->|製品情報| P2_5
    D2 -->|使用レシピ情報| P2_5
    P2_5 -->|ストック詳細| User
```

### 検索・フィルタープロセス

```mermaid
flowchart TD
    User[ユーザー] -->|検索リクエスト| P3_1[キーワード検索処理]
    User -->|ストック優先フィルターリクエスト| P3_2[ストック優先フィルター処理]
    User -->|タグ検索リクエスト| P3_3[タグ検索処理]
    
    P3_1 -->|検索条件| D1[(レシピDB)]
    P3_1 -->|検索条件| D2[(材料DB)]
    D1 -->|検索結果| P3_1
    D2 -->|検索結果| P3_1
    P3_1 -->|検索結果| User
    
    P3_2 -->|ユーザーID| D5[(ストックDB)]
    P3_2 -->|製品ID| D2
    P3_2 -->|製品ID| D3[(アウトプットDB)]
    D5 -->|ストック情報| P3_2
    D2 -->|使用レシピ情報| P3_2
    D3 -->|生成レシピ情報| P3_2
    D1 -->|レシピ情報| P3_2
    P3_2 -->|フィルター結果| User
    
    P3_3 -->|タグ情報| D7[(タグDB)]
    P3_3 -->|レシピID| D1
    D7 -->|タグ情報| P3_3
    D1 -->|レシピ情報| P3_3
    P3_3 -->|検索結果| User
```

### 認証プロセス

```mermaid
flowchart TD
    User[ユーザー] -->|認証リクエスト| P4_1[Google認証処理]
    User -->|ログアウトリクエスト| P4_2[ログアウト処理]
    
    P4_1 -->|認証リクエスト| Google[Google認証]
    Google -->|認証結果| P4_1
    P4_1 -->|ユーザー情報| D6[(ユーザーDB)]
    D6 -->|ユーザー情報| P4_1
    P4_1 -->|セッション情報| User
    
    P4_2 -->|セッション無効化| User
```

## データストアの詳細

### レシピDB
- RECIPESテーブル
- RECIPE_COMPONENTSテーブル
- RECIPE_OUTPUTSテーブル

### ストックDB
- STOCKSテーブル

### 製品DB
- PRODUCTSテーブル

### ユーザーDB
- USERSテーブル

### タグDB（Phase 2以降）
- TAGSテーブル
- RECIPE_TAGSテーブル

## 外部エンティティ

### ユーザー
- システムの利用者
- レシピ・ストックの登録・編集・削除
- 検索・フィルターの利用

### Google認証
- OAuth 2.0認証サービス
- ユーザー認証情報の提供

### YouTube
- 動画URLの提供
- 外部アプリで動画を再生

## データフローの説明

### レシピ登録フロー
1. ユーザーがレシピ登録リクエストを送信
2. レシピ管理プロセスがレシピ情報をレシピDBに保存
3. 材料情報を材料DBに保存
4. アウトプット情報をアウトプットDBに保存
5. 製品情報を製品DBに保存（必要に応じて）
6. 登録結果をユーザーに返す

### ストック登録フロー
1. ユーザーがストック登録リクエストを送信
2. ストック管理プロセスが製品情報を製品DBに保存（必要に応じて）
3. ストック情報をストックDBに保存
4. レシピとの紐づけ情報を保存
5. 登録結果をユーザーに返す

### ストック優先フィルターフロー
1. ユーザーがストック優先フィルターリクエストを送信
2. 検索・フィルタープロセスがユーザーのストック情報を取得
3. ストックの種類に応じてレシピをフィルター
   - 完成品：アウトプットDBから該当レシピを検索
   - 中間成果物・食材：材料DBから該当レシピを検索
4. フィルター結果をユーザーに返す

### 認証フロー
1. ユーザーが認証リクエストを送信
2. 認証プロセスがGoogle認証にリダイレクト
3. Google認証が認証結果を返す
4. 認証プロセスがユーザー情報をユーザーDBに保存または更新
5. セッション情報をユーザーに返す



