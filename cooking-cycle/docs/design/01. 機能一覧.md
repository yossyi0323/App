# 機能一覧

## 機能の分類

### 1. レシピ管理機能
### 2. ストック管理機能
### 3. 献立提案機能（検索・フィルター）
### 4. 認証機能
### 5. PWA対応

## 1. レシピ管理機能

### 1.1 基本レシピ登録
**機能ID:** RECIPE_CREATE  
**優先順位:** Phase 1  
**依存関係:** なし

**入力:**
- レシピ名（必須）
- 材料一覧（必須）
	- ストック管理する材料：PRODUCTSから選択
	- ストック管理しない材料：テキスト入力
	- 量・単位のメモ（任意）
	- オプション材料か（任意）
- 手順（OrderedList、テキスト入力、必須）
- YouTube URL（任意）
- タイムスタンプ（任意）

**処理:**
- バリデーション（レシピ名、材料、手順の必須チェック）
- レシピテーブルにレコード作成
- RECIPE_COMPONENTSテーブルに材料情報を登録
- RECIPE_OUTPUTSテーブルにアウトプット情報を登録（主なアウトプット）

**出力:**
- レシピID
- 作成成功/失敗の結果

### 1.2 基本レシピ編集
**機能ID:** RECIPE_UPDATE  
**優先順位:** Phase 1  
**依存関係:** RECIPE_CREATE

**入力:**
- レシピID（必須）
- レシピ名（必須）
- 材料一覧（必須）
- 手順（必須）
- YouTube URL（任意）
- タイムスタンプ（任意）

**処理:**
- バリデーション
- レシピテーブルのレコード更新
- RECIPE_COMPONENTSテーブルの更新（削除→再登録）
- RECIPE_OUTPUTSテーブルの更新

**出力:**
- 更新成功/失敗の結果

### 1.3 基本レシピ削除
**機能ID:** RECIPE_DELETE  
**優先順位:** Phase 1  
**依存関係:** RECIPE_CREATE

**入力:**
- レシピID（必須）

**処理:**
- レシピの所有権確認（ユーザーIDチェック）
- 関連レコードの削除チェック（アレンジレシピ、ストックとの紐づけ）
- **依存関係のチェック（Phase 1）:**
	- 他のレシピの材料（RECIPE_COMPONENTS）として参照されているか
	- アレンジレシピの親レシピ（parent_recipe_id）として参照されているか
	- ストックの作成元（created_from_recipe_id）として参照されているか
- **依存関係がある場合**: 削除を制限し、エラーメッセージを表示
- **依存関係がない場合**: 論理削除（`deleted_at`に日時を設定）
	- RECIPE_COMPONENTSテーブルから削除
	- RECIPE_OUTPUTSテーブルから削除

**出力:**
- 削除成功/失敗の結果
- 依存関係がある場合は、依存関係の詳細を返す

### 1.4 レシピ一覧表示
**機能ID:** RECIPE_LIST  
**優先順位:** Phase 1  
**依存関係:** なし

**入力:**
- ユーザーID（必須）
- ページネーション情報（任意）
- ソート条件（任意）

**処理:**
- ユーザーが所有するレシピを取得
- ページネーション処理
- ソート処理

**出力:**
- レシピ一覧（レシピID、レシピ名、作成日時など）

### 1.5 レシピ詳細表示
**機能ID:** RECIPE_DETAIL  
**優先順位:** Phase 1  
**依存関係:** RECIPE_LIST

**入力:**
- レシピID（必須）

**処理:**
- レシピ情報の取得
- 材料情報の取得（RECIPE_COMPONENTS）
- アウトプット情報の取得（RECIPE_OUTPUTS）
- ストック管理する材料の在庫有無確認（STOCKSテーブル参照）
- アレンジレシピ一覧の取得（基本レシピの場合）

**出力:**
- レシピ詳細情報
- 材料一覧（在庫有無含む）
- 手順
- YouTube URL
- アレンジレシピ一覧（基本レシピの場合）

### 1.6 アレンジレシピ登録
**機能ID:** RECIPE_ARRANGE_CREATE  
**優先順位:** Phase 1.5  
**依存関係:** RECIPE_CREATE

**入力:**
- 親レシピID（必須）
- レシピ名（必須）
- 追加・変更材料（任意）
- 手順の変更（任意）
- YouTube URL（任意）

**処理:**
- 親レシピの存在確認
- バリデーション
- レシピテーブルにレコード作成（parent_recipe_idを設定）
- RECIPE_COMPONENTSテーブルに材料情報を登録（親レシピの材料を継承しつつ、追加・変更を反映）
- RECIPE_OUTPUTSテーブルにアウトプット情報を登録

**出力:**
- レシピID
- 作成成功/失敗の結果

### 1.7 アレンジレシピ編集
**機能ID:** RECIPE_ARRANGE_UPDATE  
**優先順位:** Phase 1.5  
**依存関係:** RECIPE_ARRANGE_CREATE

**入力:**
- レシピID（必須）
- レシピ名（必須）
- 追加・変更材料（任意）
- 手順の変更（任意）
- YouTube URL（任意）

**処理:**
- バリデーション
- レシピテーブルのレコード更新
- RECIPE_COMPONENTSテーブルの更新
- RECIPE_OUTPUTSテーブルの更新

**出力:**
- 更新成功/失敗の結果

### 1.8 アレンジレシピ一覧表示
**機能ID:** RECIPE_ARRANGE_LIST  
**優先順位:** Phase 1.5  
**依存関係:** RECIPE_DETAIL

**入力:**
- 親レシピID（必須）

**処理:**
- 親レシピIDでアレンジレシピを検索
- アレンジレシピ一覧を取得

**出力:**
- アレンジレシピ一覧（レシピID、レシピ名など）

## 2. ストック管理機能

### 2.1 ストック登録
**機能ID:** STOCK_CREATE  
**優先順位:** Phase 1  
**依存関係:** なし

**入力:**
- ストック名（必須）
- ストックの種類（完成品/中間成果物/食材、必須）
- 量（2食分、大、など、任意）
- 食材の状態メモ（Phase 1：自由入力、任意 / Phase 2以降：状態遷移から選択、任意）
- 冷凍開始日（デフォルトは今日、必須）
- 場所メモ（Phase 2以降、任意）
- どのレシピから作られたか（Optional）
- どのレシピの材料になるか（Optional、複数可）

**処理:**
- バリデーション（ストック名、種類、冷凍開始日の必須チェック）
- PRODUCTSテーブルから該当製品を取得または作成
- STOCKSテーブルにレコード作成
	- Phase 1：`state_memo`に状態メモを保存（自由入力）
	- Phase 2以降：`ingredient_id`と`state_transition_id`を設定（状態遷移から選択）
- レシピとの紐づけ（created_from_recipe_id、RECIPE_COMPONENTSテーブルから逆引き）

**出力:**
- ストックID
- 作成成功/失敗の結果

### 2.2 ストック編集
**機能ID:** STOCK_UPDATE  
**優先順位:** Phase 1  
**依存関係:** STOCK_CREATE

**入力:**
- ストックID（必須）
- ストック名（必須）
- ストックの種類（必須）
- 量（任意）
- 食材の状態メモ（Phase 1：自由入力、任意 / Phase 2以降：状態遷移から選択、任意）
- 冷凍開始日（必須）
- 場所メモ（任意）
- どのレシピから作られたか（Optional）
- どのレシピの材料になるか（Optional）

**処理:**
- バリデーション
- ストックの所有権確認（ユーザーIDチェック）
- STOCKSテーブルのレコード更新

**出力:**
- 更新成功/失敗の結果

### 2.3 ストック削除
**機能ID:** STOCK_DELETE  
**優先順位:** Phase 1  
**依存関係:** STOCK_CREATE

**入力:**
- ストックID（必須）

**処理:**
- ストックの所有権確認（ユーザーIDチェック）
- STOCKSテーブルから削除

**出力:**
- 削除成功/失敗の結果

### 2.4 ストック一覧表示
**機能ID:** STOCK_LIST  
**優先順位:** Phase 1  
**依存関係:** なし

**入力:**
- ユーザーID（必須）
- ページネーション情報（任意）
- ソート条件（任意）
- フィルター条件（種類、日付など、任意）

**処理:**
- ユーザーが所有するストックを取得
- 消費推奨アラートの判定（1ヶ月以上経過したストックを識別）
- ページネーション処理
- ソート・フィルター処理

**出力:**
- ストック一覧（ストックID、ストック名、種類、冷凍開始日、消費推奨アラートフラグなど）

### 2.5 ストック詳細表示
**機能ID:** STOCK_DETAIL  
**優先順位:** Phase 1  
**依存関係:** STOCK_LIST

**入力:**
- ストックID（必須）

**処理:**
- ストック情報の取得
- このストックを使うレシピ一覧の取得（このストックが材料になるレシピ）
	- RECIPE_COMPONENTSテーブルから、このストック（PRODUCTS）を使うレシピを検索

**出力:**
- ストック詳細情報
- このストックを使うレシピ一覧

### 2.6 ストック消費処理
**機能ID:** STOCK_CONSUME  
**優先順位:** Phase 1  
**依存関係:** STOCK_DETAIL

**入力:**
- ストックID（必須）
- 消費方法（削除/量を減らす、必須）

**処理:**
- ストックの所有権確認
- 消費方法に応じた処理
	- 削除：STOCKSテーブルから削除
	- 量を減らす：量のメモを更新（Phase 1では削除のみ実装）

**出力:**
- 消費成功/失敗の結果

## 2.7 食材の状態遷移管理（Phase 2以降）

### 2.7.1 食材マスタ登録
**機能ID:** INGREDIENT_CREATE  
**優先順位:** Phase 2  
**依存関係:** なし

**入力:**
- 食材名（必須）
- 食材カテゴリ（任意）

**処理:**
- バリデーション（食材名の必須チェック）
- INGREDIENTSテーブルにレコード作成

**出力:**
- 食材ID
- 作成成功/失敗の結果

### 2.7.2 処理マスタ登録
**機能ID:** PROCESS_CREATE  
**優先順位:** Phase 2  
**依存関係:** なし

**入力:**
- 処理名（必須）
- 処理の説明（任意）
- 処理カテゴリ（任意）
- 処理のパラメータ（任意、JSON形式）

**処理:**
- バリデーション（処理名の必須チェック）
- PROCESSESテーブルにレコード作成

**出力:**
- 処理ID
- 作成成功/失敗の結果

### 2.7.3 状態遷移登録
**機能ID:** STATE_TRANSITION_CREATE  
**優先順位:** Phase 2  
**依存関係:** INGREDIENT_CREATE, PROCESS_CREATE

**入力:**
- 食材ID（必須）
- 処理ID（必須）
- 出力状態名（必須）
- 出力状態の別名（任意）

**処理:**
- バリデーション（食材ID、処理ID、出力状態名の必須チェック）
- 同じ食材と処理の組み合わせが既に存在しないかチェック（UNIQUE制約）
- INGREDIENT_STATE_TRANSITIONSテーブルにレコード作成

**出力:**
- 状態遷移ID
- 作成成功/失敗の結果

### 2.7.4 状態遷移一覧表示
**機能ID:** STATE_TRANSITION_LIST  
**優先順位:** Phase 2  
**依存関係:** STATE_TRANSITION_CREATE

**入力:**
- 食材ID（任意）
- 処理ID（任意）

**処理:**
- 食材IDまたは処理IDで状態遷移を検索
- 状態遷移一覧を取得

**出力:**
- 状態遷移一覧（状態遷移ID、食材名、処理名、出力状態名、別名など）

## 3. 献立提案機能（検索・フィルター）

### 3.1 ストック優先フィルター
**機能ID:** RECIPE_FILTER_BY_STOCK  
**優先順位:** Phase 1  
**依存関係:** STOCK_LIST, RECIPE_LIST

**入力:**
- ユーザーID（必須）

**処理:**
- ユーザーが所有するストック一覧を取得
- ストックの種類に応じてレシピをフィルター
	- 完成品：そのまま使えるレシピを提案（RECIPE_OUTPUTSで該当ストックをアウトプットに持つレシピ）
	- 中間成果物：その中間成果物を使うレシピを提案（RECIPE_COMPONENTSで該当ストックを材料に持つレシピ）
	- 食材：その食材を使うレシピを提案（RECIPE_COMPONENTSで該当ストックを材料に持つレシピ）
- Phase 2以降：ストックの状態とレシピの要求状態をマッチング
	- レシピの`required_state_transition_id`がNULL → 任意の状態でマッチ
	- レシピの`required_state_transition_id`が指定されている → ストックの`state_transition_id`と一致する必要がある

**出力:**
- フィルターされたレシピ一覧

### 3.2 キーワード検索
**機能ID:** RECIPE_SEARCH_KEYWORD  
**優先順位:** Phase 1  
**依存関係:** RECIPE_LIST

**入力:**
- ユーザーID（必須）
- キーワード（必須）

**処理:**
- レシピ名、材料名、手順からキーワード検索
- 部分一致検索

**出力:**
- 検索結果のレシピ一覧

### 3.3 タグ検索（AND/OR/NOT）
**機能ID:** RECIPE_SEARCH_TAG  
**優先順位:** Phase 2  
**依存関係:** RECIPE_LIST

**入力:**
- ユーザーID（必須）
- タグ一覧（必須）
- 検索条件（AND/OR/NOT、必須）

**処理:**
- タグテーブルから該当タグを取得
- 検索条件に応じてレシピをフィルター
	- AND：すべてのタグを含むレシピ
	- OR：いずれかのタグを含むレシピ
	- NOT：指定タグを含まないレシピ

**出力:**
- 検索結果のレシピ一覧

### 3.4 複合条件検索
**機能ID:** RECIPE_SEARCH_COMPLEX  
**優先順位:** Phase 2  
**依存関係:** RECIPE_SEARCH_KEYWORD, RECIPE_SEARCH_TAG

**入力:**
- ユーザーID（必須）
- キーワード（任意）
- タグ一覧（任意）
- ストック優先フィルター（任意）
- 検索条件（AND/OR/NOT、任意）

**処理:**
- 複数の検索条件を組み合わせて検索
- 条件の優先順位を考慮

**出力:**
- 検索結果のレシピ一覧

## 4. 認証機能

### 4.1 Google認証
**機能ID:** AUTH_GOOGLE  
**優先順位:** Phase 1  
**依存関係:** なし

**入力:**
- Googleアカウント情報（OAuth）

**処理:**
- Google OAuth認証
- ユーザー情報の取得
- USERSテーブルにユーザー情報を登録または更新

**出力:**
- セッション情報
- ユーザーID

### 4.2 ログアウト
**機能ID:** AUTH_LOGOUT  
**優先順位:** Phase 1  
**依存関係:** AUTH_GOOGLE

**入力:**
- セッション情報（必須）

**処理:**
- セッションの無効化

**出力:**
- ログアウト成功/失敗の結果

## 5. PWA対応

### 5.1 ホーム画面追加
**機能ID:** PWA_INSTALL  
**優先順位:** Phase 1  
**依存関係:** なし

**入力:**
- なし（ブラウザの機能）

**処理:**
- PWAマニフェストの提供
- アイコンの提供（192x192、512x512）

**出力:**
- ホーム画面への追加完了

## 機能間の依存関係

```
認証機能
  ↓
レシピ管理機能
  ↓
ストック管理機能
  ↓
献立提案機能
```

- 認証機能はすべての機能の前提
- ストック管理機能はレシピ管理機能と連携（ストックとレシピの紐づけ）
- 献立提案機能はレシピ管理機能とストック管理機能に依存

## 機能の優先順位まとめ

### Phase 1（必須）
- 認証機能（Google認証、ログアウト）
- レシピ管理機能（基本CRUD、一覧・詳細表示）
- ストック管理機能（基本CRUD、一覧・詳細表示、消費処理）
- ストック優先フィルター
- キーワード検索
- PWA対応

### Phase 1.5（コア機能）
- アレンジレシピ機能（登録・編集・一覧表示）

### Phase 2（拡張機能）
- 食材の状態遷移の本格的な管理（正規化）
	- 食材マスタ登録・一覧表示
	- 処理マスタ登録・一覧表示
	- 状態遷移登録・一覧表示
	- ストック登録時に状態遷移から選択
	- レシピの材料指定に状態遷移を含める
	- ストックの状態とレシピの要求状態のマッチング
- レシピの循環参照検出機能
	- レシピの依存関係をグラフ構造（DAG）として管理
	- 循環参照（無限ループ）の検出とエラー表示
	- レシピ削除時の依存関係チェック
- タグ機能
- タグ検索（AND/OR/NOT）
- 複合条件検索

### Phase 3（将来的な拡張）
- レシピが他のレシピの材料になる構造の完全対応
- レシピの依存グラフの可視化
	- レシピの依存関係を視覚化するUI
	- 依存グラフの表示（DAG可視化）
- 単位変換レイヤー（Unit Conversion）
	- 食材マスタに標準単位（`standard_unit`）を追加
	- 容積・重量の変換係数を持たせる「単位変換メソッド」
	- 在庫計算の精度向上（例：大さじ1 = 15ml、玉ねぎ1個 = 200g）
- 複数の戻り値（副産物）の管理
- 共通プロセスの再利用
- 全体調整・トータルコーディネート

