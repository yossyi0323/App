# 概念データモデル（ER図）

## 設計のポイント

このER図は、機能要件定義書で議論した「レシピ = メソッド」の概念を反映した設計です。

### 主要な設計判断

1. **PRODUCTSテーブル：** 材料・中間生成物・完成品・調味料のカタログ（概念）。ストックの種類（完成品/中間成果物/食材）は`type`で管理

2. **RECIPE_COMPONENTS：** レシピのインプット（引数）
	- `input_type`で入力方法を区別（PRODUCT または TEXT_INPUT）
	- ストック管理する材料は`product_id`でPRODUCTSを参照
	- ストック管理しない材料（調味料など）は`ingredient_name`で記録
	- `product_id`と`ingredient_name`は排他制約

3. **RECIPE_OUTPUTS：** レシピのアウトプット（戻り値）
	- `is_main_output`で主なアウトプットと副産物を区別
	- アウトプットは必ずPRODUCTSに登録されている必要がある

4. **STOCKS：** 物理的な在庫
	- 複合主キー`(user_id, product_id)`で、ユーザーごとに製品ごとの在庫を管理
	- `status`で在庫状態を管理（AVAILABLE, NEED_REFILL, NO_REFILL）
	- `created_from_recipe_id`で、どのレシピから作られたかを記録

5. **アレンジレシピ：** `parent_recipe_id`で基本レシピへの参照を保持（継承ロジックなし、複製元の記録のみ）

6. **システム共通カラム：** 全テーブルに`created_at`, `updated_at`, `updated_count`を追加

## ER図

```mermaid
erDiagram
    USERS ||--o{ RECIPES : has
    USERS ||--o{ STOCKS : manages_stock_status
    STOCKS ||--|| PRODUCTS : tracks_product_status

    RECIPES ||--o{ RECIPE_COMPONENTS : uses_as_input
    RECIPES ||--o{ RECIPE_OUTPUTS : generates_output

PRODUCTS {
    uuid id PK "材料・中間生成物・完成品・調味料のカタログ（概念）"
    varchar name "例: 鶏もも肉, 塩コショウ, ミートソース, 冷凍ご飯"
    varchar type "raw_material, intermediate, final_dish, seasoning, other"
    boolean is_stockable "冷凍庫ストック管理の対象か"
    timestamp created_at "レコード作成日時"
    timestamp updated_at "レコード更新日時"
    integer updated_count "レコード更新回数"
}

RECIPES {
    uuid recipe_id PK
    uuid user_id FK "レシピの所有者"
    uuid parent_recipe_id FK "(Optional) 複製元のレシピID（継承ロジックなし）"
    varchar name "レシピ名"
    varchar recipe_url "レシピURL"
    text instructions_text "手順（テキスト、改行区切り）"
    timestamp created_at "レコード作成日時"
    timestamp updated_at "レコード更新日時"
    integer updated_count "レコード更新回数"
}

RECIPE_COMPONENTS {
    uuid component_id PK
    uuid recipe_id FK
    uuid product_id FK "(Nullable)インプットとなる製品/材料のID (ストック品の場合)"
    varchar ingredient_name "【product_idと排他】インプットの名称 (ストック管理しない材料の場合)"
    varchar input_type "PRODUCT または TEXT_INPUT (どちらの入力方法かを示す)"
    text quantity_memo "量・単位のメモ（曖昧な量も許容）"
    boolean is_optional "オプション材料か"
    timestamp created_at "レコード作成日時"
    timestamp updated_at "レコード更新日時"
    integer updated_count "レコード更新回数"
}

RECIPE_OUTPUTS {
    uuid output_id PK
    uuid recipe_id FK
    uuid product_id "アウトプットとなる製品/材料のID (必ずPRODUCTSに登録)"
    text quantity_memo "量・単位のメモ（曖昧な量も許容）"
    boolean is_main_output "主生成物か（最終料理など）"
    timestamp created_at "レコード作成日時"
    timestamp updated_at "レコード更新日時"
    integer updated_count "レコード更新回数"
}

STOCKS {
    uuid user_id PK, FK "在庫の所有者"
    uuid product_id PK, FK "【在庫している】PRODUCTSのID"
    varchar status "在庫の状態: 'AVAILABLE'(在庫有), 'NEED_REFILL'(要補充), 'NO_REFILL'(補充不要)"
    text quantity_memo "在庫の量・単位のメモ（例: 個, パック, タッパー）"
    timestamp stocked_since_date "statusがAVAILABLEになった最新の日時"
    uuid created_from_recipe_id "(Optional)このストックを作ったレシピのID"
    timestamp created_at "レコード作成日時"
    timestamp updated_at "レコード更新日時"
    integer updated_count "レコード更新回数"
}